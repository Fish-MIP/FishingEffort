---
title: "Reconstruct effort for spin-up (1850-1950)"
author: "Camilla Novaglio"
date: "July 2022"
output: 
  html_document:
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message=FALSE)
```

The **AIM** of this file is to extrapolate fishing effort between 1850 and 1950 for model spin up.  

The **METHOD** follows two steps:   

1. We extrapolated effort between 1850 and 1950 for each LME. We followed two paths depending on which data was available:   

    a. If there were at least 10 years of catch data before 1950, **we used catch time series** to extrapolate effort. Firstly, we fit a GAM on the catch data and thus modeled catch as a spline-based smooth function of year, assuming a Gaussian distribution of data, a log link function, and a k argument of 6. The k argument sets the dimensionality of the smoothing matrix for the parameter year, with lower k resulting in smoother fitted spline. We used this model to predict catches between 1850 and 1950. Secondly, we looked at observed and predicted values and corrected for unexpected patterns. This meant trimming the catch data, adjusting the k argument, and re-fitting the GAM. Specifically, we identified the pick in the catch time series and excluded data collected afterwards. This was because we assumed a sigmoid-shaped catch time-series (smooth increase in catch until the pick is reached) and considering only the ascendant part of the curve resulted in a better statistical fit. In addition, we lowered k if, for example, predicted catches showed oscillations and/or resulted in high predicted effort (using the methods described below). Lastly, we calculated the rate of change of the predicted catches between 1951 and 1850 relative to the avarage catches between 1945 and 1955, and we applied this rate of change to the effort data to extend the effort time-series to 1850. When fitting the GAM, we considered data collected during WWI and WWII (1914-1918 and 1939-1945) to make use of all available information and to capture fluctuations in catches and effort.

    b. If there were less than 10 years of catch data before 1950, **we used effort time series** from 1950 to 2017 to extrapolate effort. Similar to the approach used when we considered catch time-series, we fit a GAM to the effort data and modeled effort as a spline-based smooth function of year. THen we used the GAM model to predict effort between 1850 and 1950. Assumptions, data adjustments and arguments used in this process were the same as the one used to model the catch data.  

2. Once we obtained an effort time series extending from 1850 to 2017 for each LME, we used the contribution of effort by EEZ, fishing country, gear, functional group, and sector between 1950 and 1960 to allocate effort across these groups.    

**Input files:**.  

effort_histsoc_1950_2017.csv (script 02 + 05) from Yannick Rousseau. 

catch_histsoc_1869_2017.csv (script 07) for catch data including both historical (before 1950) and recent (after 1950) years from Reg Watson.  

**Functions:**.  

effort_extrapolate(). 

effort_spread().  

**OUTPUT:**.      

1. **reconstructed_effort_for_spinup_totLME.pdf** shows (A) trends in catches, and (B) trend in effort for each LME. Predictions from the GAM model are shown as a fitted line on either catch or effort depending on the approach used (1 or 2 above). The shape of the dots refer to whether data was used in the prediction or not (i.e. data collected after the pick in catches).       

2. **reconstructed_effort_for_spinup.pdf** shows trends in fishing effort by gear (taken as an effort grouping example) and hence the distribution of the reconstructed effort for spin-up (1850-1950) across these groups.  

3. **effort_histsoc_1850_2017.csv** final spin-up and effort forcing data. 1850-1950 spin-up (extrapolated), 1950-1961 transition (available), 1962-2010 experiment (available), and 2011-2017 validation (available).     

*NOTES:*.  

1. Historical catch data is only available for some countries, and this might underestimate catches when aggregating at LME.    

2. Yannick & Reg: There will be mismatches between effort and catches - e.g., gears withing an LME that have catch but no effort, and vice versa. About 70% compatibility between the 2 datasets. Mismatches are due to the different ways the 2 datasets were built: Yannick starts from gear to reconstruct effort (e.g. 30 trawlers in fleet) while Reg does not have info on gear so assumes gear based on limited knowledge (e.g most tuna are caught by purse seine) -> effort by gear and fishing group might be different from catch by fishing group. Data aggregation might solve some of these missmatches.  

3. War inclusion decisions. Three options:   
include war years in all analyses. (Chosen option).   
exclude war years in all analyses.   
exclude war years when fitting the GAM, then replace predictions with observed catches for these years before calculating effort from catches to best capture the effect of war on effort. (This results in sudden changes in effort during spin up)    

## Set environment 

```{r environment, echo = FALSE}

rm(list=ls())

# install.packages("tidyverse")
# stringr
# fs
# ps

library(tidyverse)
library(dtplyr)
library(tictoc)
library(data.table)
library(mgcv)
library(gridExtra)

select<-dplyr::select

```

## Effort data 

```{r effort, echo = FALSE}

# effort<-read_csv("/rd/gem/private/users/yannickr/effort_histsoc_1950_2017.csv")
# consider new aggregation using EEZ instead of administrative country 
effort<-read_csv("/rd/gem/private/users/yannickr/effort_histsoc_1950_2017_EEZ.csv")
effort<-effort[,-1]
head(effort)

# Remove Unknown_EEZ before calcualting spin-up. Yannick: used to make things working, should not include much effort and it refers to all the unknown fishing trips in the raw data. Also explored in end of 07_catch
effort<-effort %>% 
  filter(FGroup != "Unknown_EEZ")

# head(effort)

```

## Catch data 

```{r catch, echo = FALSE}

catch<- read_csv("/rd/gem/private/users/yannickr/catch_histsoc_1869_2017_EEZ.csv")

# calculate catch as sum of reported and IUU, discards are generally not considered - as per Reg's comment (see 07_cacth_data.rmd) 
catch$catch_tot<-catch$Reported + catch$IUU

# not sure about above as this might have referred to historical only... but see email conversation with Reg on discards 
# catch$catch_tot<-catch$Reported + catch$IUU + catch$Discards

head(catch)

```

## Define plot theme 

```{r theme, echo = FALSE}

my_theme<-theme_bw()+
  theme(text = element_text(size = 10), # this should be overwritten by the below
        plot.title = element_text(size = 10),
        axis.title = element_text(size = 9),
        axis.text = element_text(size = 8),
        legend.title=element_text(size = 9), 
        legend.text=element_text(size = 8),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        legend.key.size = unit(0.1, "cm")) 
  
```

## Extrapolate total effort by LME function

```{r extrapolate, echo = FALSE}

toKeep<-sort(unique(effort$LME))

effort_extrapolate<-function(toKeep, kappa, war_param, war_decision, reference){
  
  # # # trial
  # toKeep=66
  # kappa=4
  # war_param = "include"
  # war_decision = "no-add"
  # reference = "1945-1955"

  effort_extr<-effort %>% 
    filter(LME %in% toKeep) %>% 
    group_by(Year) %>% 
    summarise(NomActive = sum(NomActive, na.rm = TRUE)) %>% 
    ungroup()

  maxYearEffort<-max(effort_extr$Year) 
  
  catch_all <- catch %>% 
    filter(LME %in% toKeep) %>% 
    group_by(Year) %>% 
    summarise(catch_tot = sum(catch_tot, na.rm = TRUE))
  
  ## IF ZERO ----
  # if(dim(effort_extr)[1] !=0){ 
  
  ## IF HISTORICAL catch exist ----
  if(dim(filter(catch_all, Year <1950))[1] >=10) {  
    df = catch_all
    var = "catch_tot" 
    chechDataUsed = "catch"
  }else{
      df = effort_extr
      var = "NomActive"
      chechDataUsed = "effort"
      }
  
  # find the pick in data and filter out everything after the pick  
  maxVar<-max(df[[var]])  
  maxVar<-filter(df, eval(as.name(var)) == maxVar)
  toAddBack<-filter(df, Year > maxVar$Year)
  df<-filter(df, Year <= maxVar$Year)
    
  # filter out war years: 1914-18 and 39-45
  year<-sort(unique(df$Year))
  if (year[[1]]<=1918){
    war <- df %>% 
      filter(Year %in% c(1914:1918, 1939:1945)) 
    warToRemove<-war$Year
    }else if (year[[1]]<=1945){
      war<- df %>% 
        filter(Year %in% c(1939:1945)) 
      warToRemove<-war$Year
    }

  if(year[[1]]<=1918 | year[[1]]<=1945 & war_param == "exclude"){
    df<-filter(df, !Year %in% warToRemove)
    }
    
  # fit the gam 
  gam_model<-gam(eval(as.name(var)) ~ s(Year, k=kappa), data=df, family=gaussian(link="log"))
  df$gam<-round(predict(gam_model,newdata = df,type='response'))

  # # check the gam
  # ylim = c(min(df$gam), max(df$gam))
  # plot(df$Year,df[[var]],  ylim=ylim)
  # par(new=T)
  # plot(df$Year,df$gam,col="red",type='l', ylim=ylim)

  # predict backwards
  newd <- data.frame(Year = seq(1861, maxVar$Year))
  newd$pred <- predict.gam(gam_model,newd,type='response') 
  newd$pred <- ifelse(newd$pred<=0, 0, newd$pred)
  
  # all data
  df<-df %>%
    full_join(newd, by = "Year") %>% 
    dplyr::select(-gam)
    
  if(var == "catch_tot"){
    
    # 1. calculate rate of change
    
    if(reference == "1950"){
      ref<-df %>% 
        filter(Year == 1950)
      ref<-as.numeric(ref$pred)
    }else{
      # 1B. calculate rate of change based on mean 1945-1955 years 
      ref<-df %>% 
        filter(Year >= 1945, Year <= 1955)
      ref<-as.numeric(mean(ref$pred, na.rm = TRUE))
    }
    
    # re-add war years for calculation of effort (if these were available). Add them to pred, because pred <1950 is what you are basing your calculation of effort on.
    if(war_param == "exclude" & war_decision == "re-add"){
      
    if (year[[1]]<=1914 | year[[1]]<=1939){
      df<-df %>% 
        full_join(war %>% rename(var_war = as.name(var)), by = "Year") %>% 
        mutate(pred = case_when(!is.na(var_war) ~ var_war,
                                is.na(var_war) ~ pred)) %>% 
        select(-var_war)
    }
    }
      
    rate_of_change<-df %>% 
      arrange(Year) %>% 
      mutate(pred = as.numeric(pred)) %>% 
      mutate(rate = 100 * (pred - ref)/ref) %>% 
      mutate(Trial_back = ref + (rate/100)*ref) # only to check  
  
    # check 
    # filter(rate_of_change, Year >= 1950, Year <= 1960)

    # 2. extend effort back using rate of change in catch 
    
    if(reference == "1950"){
      ref<-effort_extr %>% 
        filter(Year == 1950)
      ref<-as.numeric(ref$NomActive)
    }else{
      # 2B. extend effort back using rate of change in catch using decadal mean 
      ref<-effort_extr %>% 
        filter(Year >= 1945, Year <=1955)
      ref<-as.numeric(mean(ref$NomActive, na.rm = TRUE))
    }
  
    effort_reconstruct<-effort_extr %>% 
      full_join(rate_of_change, by = "Year") %>% 
      mutate(NomActive_catch_based = case_when(Year >= 1950 ~ NomActive,
                                               Year < 1950 ~ ref + (rate/100)*ref))
    
    # # check
    # ggplot(data = effort_reconstruct, aes(x = Year, y = NomActive_catch_based)) +
    #   geom_point()
    # ggplot(data = effort_reconstruct, aes(x = Year, y = pred)) +
    #   geom_point()

    # build effort_all
    effort_all<-effort_reconstruct %>% 
      dplyr::select(Year, NomActive_catch_based) %>% 
      rename(NomActive = NomActive_catch_based) 
    
    # consider only recent years that are in effort and not in catch 
    effort_all<-effort_all %>% 
      filter(Year <= maxYearEffort)
    
    }else{ # END var = cacth_tot; beginning of var = NomActive 
      
      # build effort based on gam on effort. 
      df<-df %>% 
        mutate(NomActive = ifelse(Year < 1950, pred, NomActive)) 
      
      } # end difference between var 
        
    # FINAL STEPS ----
    
    # 1. add missing data 
    
    # add back war time in raw catches - only if you had excluded them above
    # WARNING - CHECK THIS 
    if(war_param == "exclude"){
  
    if (year[[1]]<=1918 | year[[1]]<=1945){
      df<-df %>% 
      full_join(war %>% rename(var_war = as.name(var)), by = "Year")
    
      if(var == "catch_tot"){
        df<-df %>% 
          mutate(catch_tot = case_when(!is.na(var_war) ~ var_war,
                                       is.na(var_war) ~ eval(as.name(var)))) %>% 
          select(-var_war)
      }
      # }else{ 
      #   # is this needed? was years are only excluded on catches, not effort. 
      #   df<-df %>% 
      #     mutate(NomActive = case_when(!is.na(var_war) ~ var_war,
      #                                  is.na(var_war) ~ eval(as.name(var)))) %>% 
      #     select(-var_war)
      #   
      # }
    }
    }
    
    # add back data after pick in both catches and effort
    if (dim(toAddBack)[1]!=0){
      df<-df %>% 
        full_join(toAddBack) 
      }
  
    # define df as either catch_all or effort_all
    if(var == "catch_tot"){
      catch_all2<-df # version 2 otherwise cannot # highlight data that was not used in GAM # as catch_all is overwritten
    }else{
      effort_all<-df
      catch_all2<-catch_all 
    }
    
    # 2. merge and plot 
    final_df<-effort_all %>% 
      full_join(catch_all2, by = "Year")
    
    # add 1841-1860 at 1861 fixed values
    trial<-final_df %>% 
      filter(Year == 1861) 
  
    add_df<-data.frame(Year = seq(1841, 1860), NomActive = rep(trial$NomActive, 20))
  
    final_df<-final_df %>% 
      full_join(add_df)
    
    # # relative to 1950
    # # WARNING CHECK THIS - not sure we need it 
    # ref<-final_df %>% 
    #   filter(Year == 1950)
    # 
    # final_relative<-final_df %>% 
    #   mutate(EffRelative = (NomActive-ref$NomActive)/ref$NomActive, 
    #          PredRelative = (pred-as.numeric(ref$pred))/as.numeric(ref$pred),
    #          CatchRelative = (catch_tot-ref$catch_tot)/ref$catch_tot) 
    # 
    # final_relative<-final_relative %>% 
    #   dplyr::select(Year, EffRelative:CatchRelative) %>% 
    #   gather("Type", "Value", -Year)

    # WARNING - check Warning with gather, use pivot_longer instead
    final_df<-final_df %>% 
      pivot_longer(cols = -Year, names_to = "Type", values_to = "Value") 
 
    # final_df<-final_df %>% 
    #   gather("Type", "Value", -Year) 
  
    # grouping for plot below - these are the titles of the two stacked plots 
    if(var == "catch_tot"){
      final_df<-final_df %>% 
        mutate(group = ifelse(Type == "NomActive", "Effort (nominal, DkW)", "Catch (tonnes)") )
      
    }else(
      final_df<-final_df %>% 
        mutate(group = ifelse(Type == "catch_tot", "Catch (tonnes)", "Effort (nominal, DkW)") )
    )
    
    # highlight data that was not used in GAM 
    if(dim(filter(catch_all, Year <1950))[1] >=10 & war_param == "exclude" & war_decision != "re-add") { 
      final_df <-final_df %>% 
        mutate(Considered = ifelse(Year %in% c(1914:1918, 1939:1945), "No", "Yes"))
    }else{ 
      final_df <-final_df %>% 
        mutate(Considered = "Yes")
    }
    
    if(dim(toAddBack)[1]!=0){
      final_df <-final_df %>% 
        mutate(Considered = ifelse(Year > maxVar$Year, "No", Considered))
    }
    
    final_df_plot<-final_df %>% 
      rename(Data = Type) %>% 
      mutate(Data = ifelse(Data == "pred", "GAM predictions", "Reconstructed values"),
             Considered = as.factor(Considered))
    
    # make "yes" always a dot and never a square 
    scale_fill_chris <- function(...){
    ggplot2:::manual_scale(
        'shape', 
        values = setNames(c(16,15), c("Yes", "No")), 
        ...
    )
    }
    
    data_for_plot_for_FAOreport = final_df_plot # Added to play with plots for FAO report
    
    # create data for annotation 
    yMax = max(filter(final_df, Type == "NomActive")$Value, na.rm = TRUE)
    # ann_text <- data.frame(Year = c(1841+10,1861+15,1961+15), Value = rep(yMax,3), lab = c("Spin-up","Transition","Experiment"), group = rep("Effort (nominal, DkW)", 3), Data = rep("Reconstructed values", 3), Considered = rep("Yes", 3))
    
    ann_text <- data.frame(Year = c(1841+10,1961+15), Value = rep(yMax,2), lab = c("Transition","Experiment"), group = rep("Effort (nominal, DkW)", 2), Data = rep("Reconstructed values", 2), Considered = rep("Yes", 2))
    
    plot<-ggplot(data = final_df_plot, aes(x = Year, y = Value, group = Data, color = Data, shape=Considered)) +
      ggtitle(paste("LME", toKeep, sep = " "))+
      facet_wrap(~group, scales = "free", nrow = 2)+
      annotate("rect",xmin=1841, xmax=1960, ymin=0, ymax=Inf, fill = "#b2e2e2", alpha = 0.4)+ # spin-up edf8fb
      # annotate("rect",xmin=1861, xmax=1960, ymin=0, ymax=Inf, fill = "#66c2a4", alpha = 0.4)+ # transition b2e2e2
      annotate("rect",xmin=1961, xmax=2010, ymin=0, ymax=Inf, fill = "#238b45", alpha = 0.4)+ # projection 66c2a4
      # annotate("rect",xmin=2010, xmax=2017, ymin=0, ymax=Inf, fill = "#238b45", alpha = 0.4)+ # validation 238b45
      geom_text(data = ann_text,label = ann_text$lab, color = "Black", size = 2)+
      geom_point(data = filter(final_df_plot, Data == "Reconstructed values"),size=1)+
      geom_line(data = filter(final_df_plot, Data == "GAM predictions")) +
      scale_color_manual(values = c("blue", "black"), drop = FALSE)+
      scale_fill_chris()+
      my_theme
    
    if(var == "catch_tot"){ # different reference year are only relevent when effort reconstruction is based on catches  
      if(reference == "1950"){
        plot<-plot+
          geom_vline(xintercept=1950, linetype="dashed", color = "red", size=0.5)
      }else{
        plot<-plot+
          geom_vline(xintercept=1945, linetype="dashed", color = "red", size=0.5)+
          geom_vline(xintercept=1955, linetype="dashed", color = "red", size=0.5)
      }}
    
    # save outputs 
    return(list(reconstructed_effort_LME = final_df, plot_reconstructed_effort_LME = plot, chechDataUsed = chechDataUsed, data_for_plot_for_FAOreport = data_for_plot_for_FAOreport)) 
    
  # } # END if data exist 
  
} 

```

## Extrapolate total effort by LME loop

```{r extrapolate loop, echo = FALSE, fig.width=10, fig.height=7}

# # first loop ----
# # this is with war and ref at 1950 (this only applies to catches)
# 
# reconstructed_effort_LME_war<-list()
# plot_reconstructed_effort_LME_war<-list()
# chechDataUsed<-list()
# 
# # fix the k argument in GAM (based on war_param = "include" and reference = 1950)
# kappa_values<-data.frame(lme = toKeep, kappa = 6)
# kappa_values[c(5, 13,19, 31,56, 57, 61)+1, 2]<-5
# kappa_values[c(8)+1, 2]<-4
# 
# for(i in 1:length(toKeep)){
# 
#   print(toKeep[[i]]) 
# 
#   # yes war data when fitting GAM do not re-add original data as otherwise you overwrite predictions
#   b<-effort_extrapolate(toKeep[[i]], kappa = kappa_values[i,2], war_param = "include", war_decision = "no-add", reference = "1950")
# 
#   reconstructed_effort_LME_war[[i]]<-b$reconstructed_effort_LME
#   names(reconstructed_effort_LME_war)[i]<-toKeep[i]
# 
#   plot_reconstructed_effort_LME_war[[i]]<-b$plot_reconstructed_effort_LME
#   names(plot_reconstructed_effort_LME_war)[i]<-toKeep[i]
# 
#   chechDataUsed[[i]]<-b$chechDataUsed
#   names(chechDataUsed)[i]<-toKeep[i]
#   
# }
# 
# # plot_reconstructed_effort_LME_war[[59]]
# 
# # WARNINGS 
# 
# # Warning message:
# # Step size truncated due to divergence
# 
# # second loop ----
# # this is with alternatives but considering only the LME where calculations are based on catches 
# 
# toKeepCatch<-as.numeric(names(chechDataUsed[chechDataUsed == "catch"]))
# 
# reconstructed_effort_LME_catch<-list()
# plot_reconstructed_effort_LME_catch<-list()
# 
# reconstructed_effort_LME_war_catch<-list()
# plot_reconstructed_effort_LME_war_catch<-list()
# 
# reconstructed_effort_LME_war_original_catch<-list()
# plot_reconstructed_effort_LME_war_original_catch<-list()
# 
# reconstructed_effort_LME_ref_catch<-list()
# plot_reconstructed_effort_LME_ref_catch<-list()
# 
# for(i in 1:length(toKeepCatch)){
#   
#   print(toKeepCatch[[i]]) 
#   
#   # no war data when fitting GAM nor when calculating effort based on catch 
#   a<-effort_extrapolate(toKeepCatch[[i]], kappa = kappa_values[i,2], war_param = "exclude", war_decision = "no-add", reference = "1950")
# 
#   reconstructed_effort_LME_catch[[i]]<-a$reconstructed_effort_LME
#   names(reconstructed_effort_LME_catch)[i]<-toKeepCatch[i]
#   
#   plot_reconstructed_effort_LME_catch[[i]]<-a$plot_reconstructed_effort_LME
#   names(plot_reconstructed_effort_LME_catch)[i]<-toKeepCatch[i]
# 
#   # yes war data when fitting GAM do not re-add original data as otherwise you overwrite predictions
#   b<-effort_extrapolate(toKeepCatch[[i]], kappa = kappa_values[i,2], war_param = "include", war_decision = "no-add", reference = "1950")
# 
#   reconstructed_effort_LME_war_catch[[i]]<-b$reconstructed_effort_LME
#   names(reconstructed_effort_LME_war_catch)[i]<-toKeepCatch[i]
# 
#   plot_reconstructed_effort_LME_war_catch[[i]]<-b$plot_reconstructed_effort_LME
#   names(plot_reconstructed_effort_LME_war_catch)[i]<-toKeepCatch[i]
# 
#   # no war data when fitting GAM, re-add original data when calcualting effort based on catch
#   c<-effort_extrapolate(toKeepCatch[[i]], kappa = kappa_values[i,2], war_param = "exclude", war_decision = "re-add",reference = "1950")
# 
#   reconstructed_effort_LME_war_original_catch[[i]]<-c$reconstructed_effort_LME
#   names(reconstructed_effort_LME_war_original_catch)[i]<-toKeepCatch[i]
# 
#   plot_reconstructed_effort_LME_war_original_catch[[i]]<-c$plot_reconstructed_effort_LME
#   names(plot_reconstructed_effort_LME_war_original_catch)[i]<-toKeepCatch[i]
# 
#   # change the ref from 1950 to mean(1945-1955) to address higher bumps in effort than catches
#   d<-effort_extrapolate(toKeepCatch[[i]], kappa = kappa_values[i,2], war_param = "exclude", war_decision = "no-add", reference = "1945-1955")
# 
#   reconstructed_effort_LME_ref_catch[[i]]<-d$reconstructed_effort_LME
#   names(reconstructed_effort_LME_ref_catch)[i]<-toKeepCatch[i]
# 
#   plot_reconstructed_effort_LME_ref_catch[[i]]<-d$plot_reconstructed_effort_LME
#   names(plot_reconstructed_effort_LME_ref_catch)[i]<-toKeepCatch[i]
#   
# }
# 
# # compare scenarios and decide ----
# 
# # WAR decision
# combined_plot_war_list<-list()
# 
# for(i in 1:length(plot_reconstructed_effort_LME_catch)){
#   
#   plot_reconstructed_effort_LME_catch[[i]]<-plot_reconstructed_effort_LME_catch[[i]]+
#     ggtitle(paste("LME", toKeepCatch[[i]], "no war", sep = " ")) +
#     theme(legend.position ="none")
#   
#   plot_reconstructed_effort_LME_war_catch[[i]]<-plot_reconstructed_effort_LME_war_catch[[i]]+
#     ggtitle(paste("LME", toKeepCatch[[i]], "war", sep = " ")) +
#     theme(legend.position ="none")
#   
#   plot_reconstructed_effort_LME_war_original_catch[[i]]<-plot_reconstructed_effort_LME_war_original_catch[[i]]+
#     ggtitle(paste("LME", toKeepCatch[[i]], "war original values", sep = " ")) +
#     theme(legend.position ="none")
#   
#   # better to combine plots like this otherwise 3 plots in 1 page are too big... 
#   combined_plot_war_list[[i]]<-list(plot_reconstructed_effort_LME_catch[[i]], plot_reconstructed_effort_LME_war_catch[[i]], plot_reconstructed_effort_LME_war_original_catch[[i]])
#   
# }
# 
# combined_plot_war_list<-unlist(combined_plot_war_list, recursive=FALSE)
# 
# pdf("Output/reconstructed_effort_for_spinup_totLME_warDecision2.pdf", height = 5, width = 7)
# for (i in 1:length(combined_plot_war_list)){
#   plot(combined_plot_war_list[[i]])
# }
# dev.off()
# 
# # REFERENCE decision
# combined_plot_ref<-list()
# 
# for(i in 1:length(plot_reconstructed_effort_LME_catch)){
#   
#   plot_reconstructed_effort_LME_ref_catch[[i]]<-plot_reconstructed_effort_LME_ref_catch[[i]]+
#     ggtitle(paste("LME", toKeep[[i]], "ref 1945-1955", sep = " "))+
#     theme(legend.position ="none")
# 
#   combined_plot_ref[[i]]<-list(plot_reconstructed_effort_LME_catch[[i]], plot_reconstructed_effort_LME_ref_catch[[i]])
#   
# }
# 
# combined_plot_ref<-unlist(combined_plot_ref, recursive=FALSE)
# 
# pdf("Output/reconstructed_effort_for_spinup_totLME_refDecision2.pdf", height = 5, width = 7)
# for (i in 1:length(combined_plot_ref)){
#   plot(combined_plot_ref[[i]])
# }
# dev.off()

# final loop after DECISION ----

# if catch: include war, ref 1945-1955
# if effort - it does not matter

# fix the k argument in GAM (based on war_param = "include" and reference = 1950)
toKeep<-sort(unique(effort$LME))

df_kappa = 6 
# with kappa = 3 bumps in effort disappear and we force the perfect logarithmic shape on the catch/effort data, but GAM in most cases does not fit the data particularly well (as does not follow bumps ...)

if(df_kappa ==6){ # better capture trends 
  
  # but avoid an increase in effort from 1950 to 1841: 
  kappa_values<-data.frame(lme = toKeep, kappa = 6)  
  kappa_values[c(5,13,19,56,57,61)+1, 2]<-5
  kappa_values[c(8)+1, 2]<-4 

  # correct trends - Jerome comments
  # LME 40 not capturing slow increase in effort and resulting in high effort between 1841 and 1950, try playing with the smoothing parameter.
  kappa_values[c(40)+1, 2]<-3 # 4 and 5 won't make a change # 3 works

  # LME 29 and 31 same as above
  kappa_values[c(29,31)+1, 2]<-4 # 5 or 7 means increases # 4 works
  
  # LME 66 - warning when fitting the GAM  
  kappa_values[c(66)+1, 2]<-4 # kappa = 5 solves the problem but kappa = 4 gives a better plot
  
  # LME that do not go to 0 by 1841 or have large bumps between 1841 and 1950 - try lowering kappa 
  # 3,6,7,10 - no difference when lowering kappa - this is just due to the data itself 
  # 9 - worst 
  # 22 - 3 decreasing trend and getting closer to 0 but bad fit, 4 & 5 wrong (increasing)
  # 24 - small difference : 3 increasing, *4* nice and close to 6 but bigger bump around 1930 and lower effort in 1841, 5 wrong
  # 26 - slightly better 6
  # 42 - 3 better but fit is worst, 4 bad, *5* better and fit is OK 
  kappa_values[c(42)+1, 2]<-5
  # 43 - bump: 3 bad, *4* ok not sure which one is better, 5 bad 
  # kappa_values[c(43)+1, 2]<-4
  # 44 - bump: 4 fixes the bump but not sure this is OK as effort drops really quickly, 3 and 5 bad 
  # 49 - bump: 3 bump fixed but no fit, 4 better but not great fit, 5 same as 6 but worst fit 
  # 50, 51 - bump: not sure it should be fixed 
  # 54 - high/ish values at start of time series: could decrease quicker with *5* 
  kappa_values[c(54)+1, 2]<-5
  # 55 - bump in experiment - not important has here raw data is used
  # 57 - already lowered to 5 and OK (3 bad fit) *4* is the same as 5 but because we fit to few points should we prefer 4? 
  # kappa_values[c(57)+1, 2]<-4
  # 59 - high/ish values at start of time series: no changes with kappas  
  # 60 - all values ok but 6 has better fit and goes to 0 
  
}else if (df_kappa == 3){ # assumes a "perfect" logistic 
  
  kappa_values<-data.frame(lme = toKeep, kappa = 3)
  kappa_values[c(3,6,9,24,31,43,44,57,61)+1, 2]<-4
  kappa_values[c(62,63)+1, 2]<-5 # no solution to 64 - see below for adjustments
  
}

reconstructed_effort_LME_war_ref<-list()
plot_reconstructed_effort_LME_war_ref<-list()
data_for_plot_for_FAOreport<-list()

tic()
for(i in 1:length(toKeep)){
  
  # i = 57+1
  print(toKeep[[i]])

  # yes war data when fitting GAM do not re-add original data as otherwise you overwrite predictions, reference mean over a decade
  b<-effort_extrapolate(toKeep[[i]], kappa = kappa_values[i,2], war_param = "include", war_decision = "no-add", reference = "1945-1955")
  
  # pdf("Output/LME31.pdf")
  # b$plot_reconstructed_effort_LME
  # dev.off()

  reconstructed_effort_LME_war_ref[[i]]<-b$reconstructed_effort_LME
  names(reconstructed_effort_LME_war_ref)[i]<-toKeep[i]

  plot_reconstructed_effort_LME_war_ref[[i]]<-b$plot_reconstructed_effort_LME
  names(plot_reconstructed_effort_LME_war_ref)[i]<-toKeep[i]
  
  data_for_plot_for_FAOreport[[i]]<-b$data_for_plot_for_FAOreport # added to play with plots for FAO report
  names(data_for_plot_for_FAOreport)[i]<-toKeep[i]
  
}
toc() # 103.332 sec elapsed
# Warning messages: 3 warnings all on LME 66
# 1: Step size truncated due to divergence 
# inside gam.fit in the mgcv
# package, the model you have specified is having difficulty with your
# data. need to inspect the details of the model fit. lowered kappa above for this LME 

# show corrected trends 
# plot_reconstructed_effort_LME_war_ref[[67]]

# show Antarctica - need to be 0 before 1950 - it is zero or close to zero in both kappa cases  
# plot_reconstructed_effort_LME_war_ref[[62]]

# show north sea
# plot_reconstructed_effort_LME_war_ref[[23]]

# adjust LME 64 ----
# in LME 64 (central Arctic) effort increases back in time - use trends in LME 65 (Aleutian Island)
# not good when kappa = 3
# plot_reconstructed_effort_LME_war_ref[[65]] # the one need fixing # Should this be zero before 1950? very close to 0 very soon if we use the approach below. 
# plot_reconstructed_effort_LME_war_ref[[66]]
trial<-reconstructed_effort_LME_war_ref[[65]] 
trial1<-reconstructed_effort_LME_war_ref[[66]]

# sort(unique(trial$Year))
# sort(unique(trial1$Year))

# from function above
# use the rate of change in trial1 to calculate trial (1841-1950)

# 1B. calculate rate of change based on mean 1945-1955 years - line 225 + 243
# df = trial1
# consider only NomActive 
ref<-trial1 %>% 
  filter(Year >= 1945, Year <= 1955, 
         Type == "NomActive")
ref<-as.numeric(mean(ref$Value, na.rm = TRUE))

# only for historical stuff.. 
rate_of_change<-trial1 %>% 
  filter(Year < 1950, Type == "NomActive") %>% 
  arrange(Year) %>% 
  mutate(rate = 100 * (Value - ref)/ref) %>% 
  mutate(Trial_back = ref + (rate/100)*ref) # only to check  

unique(sort(rate_of_change$Year))

# 2. extend effort back using rate of change in catch - line 251
# 2B. extend effort back using rate of change in catch using decade mean 
# effort_extr = trial
ref<-trial %>% 
  filter(Year >= 1945, Year <= 1955,
         Type == "NomActive")
ref<-as.numeric(mean(ref$Value, na.rm = TRUE))

to_substitute<-trial %>% 
  filter(Type == "NomActive", Year < 1950) %>% 
  full_join(select(rate_of_change, Year, rate)) %>% 
  mutate(Value = ref + (rate/100)*ref) %>% 
  select(-rate)

# unique(sort(to_substitute$Year))

# add 1841-1860 at 1861 fixed values - this should be part of the above - but just in case do it again ... NO checked - it is part of the above and effort is kept at 17 as per effort in 1861 
add_df<-to_substitute %>%
  filter(Year == 1861)

# filter(to_substitute, Year <1860)

# add_df<-data.frame(Year = seq(1841, 1860), Value = rep(add_df$Value, 20))
# 
# to_substitute<-to_substitute %>%
#   full_join(add_df)

trial2<-trial %>% 
  filter(Year >= 1950, Type %in% c("NomActive", "catch_tot")) %>% # keep only catch (no historical available) and effort. 
  full_join(to_substitute) # %>% 

# unique(to_substitute$Year)
# unique(to_substitute$Type)
# # add predictions type for consistency with other dataset and plotting function
# to_add_pred<-to_substitute %>% 
#   mutate(Type = "pred")

# add predictions (from LME 65 and equal to effort)
# toAddPred<-trial2 %>% 
#   filter(Year < 1950, group == "Effort (nominal, DkW)") # %>% 
#   # mutate(Data = "GAM predictions")

toAddPred<-to_substitute %>% 
  mutate(Type = ifelse(Year > 1860,"pred", NA))

trial3<- trial2 %>% 
  full_join(toAddPred) %>% 
  mutate(Considered = "No") # none of these values were considered as the projections are taken from LME 65)

### NOTE final data structure needs to be as trial3 otherwise it does not work
# head(trial1)
# head(trial3)

# for plotting only 
# unique(trial3$Type)
trial3_toPlot<-trial3 %>% 
  rename(Data = Type) %>% 
  mutate(Data = ifelse(Data == "pred", "GAM predictions", "Reconstructed values"))

# plot 

yMax = max(filter(trial3, Type == "NomActive")$Value, na.rm = TRUE)
# ann_text <- data.frame(Year = c(1841+10,1861+15,1961+15,1841+30), Value = c(rep(yMax,3),yMax-25000), lab = c("Spin-up","Transition","Experiment","*Predictions taken from LME 65"), group = rep("Effort (nominal, DkW)", 4), Data = rep("Reconstructed values", 4), Considered = rep("Yes", 4))

ann_text <- data.frame(Year = c(1841+10,1961+15,1841+30), Value = c(rep(yMax,2),yMax-25000), lab = c("Transition","Experiment","*Predictions taken from LME 65"), group = rep("Effort (nominal, DkW)", 3), Data = rep("Reconstructed values", 3), Considered = rep("Yes", 3))

# make "yes" always a dot and never a square 
scale_fill_chris <- function(...){
  ggplot2:::manual_scale(
    'shape', 
    values = setNames(c(16,15), c("Yes", "No")), 
    ...
  )
  }

plot_LME64<-ggplot(data = trial3_toPlot, aes(x = Year, y = Value, group = Data, color = Data)) + # shape=Considered
  ggtitle(paste("LME 64", sep = " "))+
  facet_wrap(~group, scales = "free", nrow = 2)+
  annotate("rect",xmin=1841, xmax=1960, ymin=0, ymax=Inf, fill = "#b2e2e2", alpha = 0.4)+ # spin-up edf8fb
  # annotate("rect",xmin=1861, xmax=1960, ymin=0, ymax=Inf, fill = "#66c2a4", alpha = 0.4)+ # transition b2e2e2
  annotate("rect",xmin=1961, xmax=2010, ymin=0, ymax=Inf, fill = "#238b45", alpha = 0.4)+ # projection 66c2a4
  geom_text(data = ann_text,label = ann_text$lab, color = "Black", size = 2)+
  geom_point(data = filter(trial3_toPlot, Data == "Reconstructed values"),size=1)+
  geom_line(data = filter(trial3_toPlot, Data == "GAM predictions"))+
  scale_color_manual(values = c("blue", "black"), drop = FALSE)+
  scale_fill_chris()+
  my_theme+
  geom_vline(xintercept=1945, linetype="dashed", color = "red", size=0.5)+
  geom_vline(xintercept=1955, linetype="dashed", color = "red", size=0.5)

# prediction missing as coming from a different LME ... 
reconstructed_effort_LME_war_ref[[65]]<-trial3
plot_reconstructed_effort_LME_war_ref[[65]]<-plot_LME64

# adjust LME 61 ----
# Antarctica - effort = 0 before 1950

# save and print plots ----

# check empty LME and remove from the list - it should be none
plot_reconstructed_effort_LME_war_ref<-plot_reconstructed_effort_LME_war_ref[lapply(plot_reconstructed_effort_LME_war_ref,length)>0]

if(df_kappa == 6){
  name = "Output/reconstructed_effort_for_spinup_totLME2_JeromeComments_kappa6_1841_fixedValues_kappaLME31_EEZ.pdf" # this cversion uses EEZ instead of administrative country
}else if (df_kappa == 3){
  name = "Output/reconstructed_effort_for_spinup_totLME2_JeromeComments_kappa3_1841_fixedValues_kappaLME31_EEZ.pdf"
}

# if total catch included discards - no need see comment above:  

# if(df_kappa == 6){
#   name = "Output/reconstructed_effort_for_spinup_totLME2_JeromeComments_kappa6_discards.pdf"
# }else if (df_kappa == 3){
#   name = "Output/reconstructed_effort_for_spinup_totLME2_JeromeComments_kappa3_discards.pdf"
# }

# name = "Output/justChecking.pdf"
pdf(name, height = 8, width = 6)
marrangeGrob(grobs = plot_reconstructed_effort_LME_war_ref, nrow=2, ncol=1)
dev.off()

# # check 
# reconstructed_effort_LME_war_ref[[1]]
# reconstructed_effort_LME_war_ref[[65]]

# ### SAVE DATA HERE as you need to create a plot of effort and gfdl intpp for the north sea in plotGFDLinputs. also need this for FAO report plots. 
# save(reconstructed_effort_LME_war_ref, plot_reconstructed_effort_LME_war_ref, data_for_plot_for_FAOreport, file = "~/FishingEffort/Data/temp_effort.RData")

```

## FAO report plots 

```{r}

# Plots for FAO report
# rm(list=ls())
# load("~/FishingEffort/Data/temp_effort.RData")

# for plotting 
# data_for_plot_for_FAOreport

# consider 2 LME only? 
# catch-based LME 50, 51, 47,39, 22,23, 14 (Patagonian shelf, better),15 (south Brazil shelf),16 (east Brazil shelf)
# effort-based LME 26, 27 (canary current), 32 (Arabian Sea), 33, 34 (Bay of bengal), 36 (South China Sea), 37 ...
# plot_reconstructed_effort_LME_war_ref[[15+1]]

# names(data_for_plot_for_FAOreport)
SBZ<-data_for_plot_for_FAOreport[[14+1]]
CC<-data_for_plot_for_FAOreport[[27+1]]

# FROM INSIDE FUNCION... 
# now manul but can be loop if lots of changes... 

# create data for annotation 
yMax = max(filter(SBZ, group == "Effort (nominal, DkW)")$Value, na.rm = TRUE)

ann_text <- data.frame(Year = c(1841+10,1961+15), Value = rep(yMax,2), lab = c("Transition","Experiment"), group = rep("Effort (nominal, DkW)", 2), Data = rep("Reconstructed values", 2), Considered = rep("Yes", 2))
    
plot_SBZ<-ggplot(data = SBZ, aes(x = Year, y = Value, group = Data, color = Data))+ #, shape=Considered)) +
  ggtitle("Patagonian Shelf")+
  facet_wrap(~group, scales = "free", nrow = 2)+
  annotate("rect",xmin=1841, xmax=1960, ymin=0, ymax=Inf, fill = "#b2e2e2", alpha = 0.4)+ # spin-up edf8fb
  annotate("rect",xmin=1961, xmax=2010, ymin=0, ymax=Inf, fill = "#238b45", alpha = 0.4)+ # projection 66c2a4
  geom_text(data = ann_text,label = ann_text$lab, color = "Black", size = 2)+
  geom_point(data = filter(SBZ, Data == "Reconstructed values"),size=1)+
  geom_line(data = filter(SBZ, Data == "GAM predictions")) +
  scale_color_manual(labels = c("Stat. model", "Estimates"), values = c("blue", "black"), drop = FALSE)+
  scale_fill_chris()+
  my_theme+
  geom_vline(xintercept=1945, linetype="dashed", color = "red", size=0.5)+
  geom_vline(xintercept=1955, linetype="dashed", color = "red", size=0.5)

yMax = max(filter(CC, group == "Effort (nominal, DkW)")$Value, na.rm = TRUE)

ann_text <- data.frame(Year = c(1841+10,1961+15), Value = rep(yMax,2), lab = c("Transition","Experiment"), group = rep("Effort (nominal, DkW)", 2), Data = rep("Reconstructed values", 2), Considered = rep("Yes", 2))
   
plot_CC<-ggplot(data = CC, aes(x = Year, y = Value, group = Data, color = Data))+ #, shape=Considered)) +
  ggtitle("Canary Current")+
  facet_wrap(~group, scales = "free", nrow = 2)+
  annotate("rect",xmin=1841, xmax=1960, ymin=0, ymax=Inf, fill = "#b2e2e2", alpha = 0.4)+ # spin-up edf8fb
  annotate("rect",xmin=1961, xmax=2010, ymin=0, ymax=Inf, fill = "#238b45", alpha = 0.4)+ # projection 66c2a4
  geom_text(data = ann_text,label = ann_text$lab, color = "Black", size = 2)+
  geom_point(data = filter(CC, Data == "Reconstructed values"),size=1)+
  geom_line(data = filter(CC, Data == "GAM predictions")) +
  scale_color_manual(labels = c("Stat. model", "Estimates"), values = c("blue", "black"), drop = FALSE)+
  scale_fill_chris()+
  my_theme+
  geom_vline(xintercept=1950, linetype="dashed", color = "red", size=0.5)

## END 

plot_SBZ<-plot_SBZ+theme(legend.position = "none")

# install.packages("patchwork")
library(patchwork)
# pdf("Output/LMEeffortFAOreport_EEZ.pdf", height = 5, width = 9)  # this version uses EEZ instead of administrative country
# plot_SBZ+plot_CC+plot_annotation(tag_levels = 'A')
# dev.off()

jpeg("Output/LMEeffortFAOreport_EEZ.jpg", width = 10, height = 5, units = 'in', res = 300, bg = "transparent")
plot_SBZ+plot_CC+plot_annotation(tag_levels = 'A')
dev.off()


```

## Allocate reconstructed effort across groups function

```{r allocate, echo = FALSE}

effort_spread<-function(historical_effort, recent_effort, toKeep, reference){
  
  # # # trial
  # historical_effort = decision[[1]] # effort from 1841 to 2017 at LME level from analysis above - missing groups (eez, gear, fgroup, saup, sector, etc.)
  # recent_effort = recent_effort # effort from 1950 to 2017 with all groups
  # toKeep = toKeep[[1]]
  # reference = "1950-1960"
  
  # calculate effort distribution across group using 1950-1960, if you use one year only you might miss important groups not represented in 1950 
  if(reference == "1950"){
    recent_effortB<-recent_effort %>% 
      filter(Year == 1950)
    }else{
      recent_effortB<-recent_effort %>% 
        filter(Year >= 1950, Year <=1960)
    }
  
  # this is done for each LME (LME in grouping below is not necessary). 
  # recent_effort is effort from 1950-2017 and recent_effortB is effort from 1950-1960 (reference years) including all groups
  # NOTE from recent_effort you consider CONTRIBUTIONS by groups 
  # first you calculate the average effort by group 1950-1960 (reference effort)
  # then you calculate the effort contribution of each group. at the LME level this sums to 1 
  
  recent_effortB<-recent_effortB %>% 
    group_by(eez_country_name,SAUP,Gear,FGroup,Sector,LME) %>% 
    summarise(NomActive = mean(NomActive, na.rm = TRUE)) %>% 
    ungroup() %>% 
    mutate(contribution = NomActive/sum(NomActive, na.rm = TRUE))
  
  # check
  sum(recent_effortB$contribution, na.rm = TRUE)
  
  # now you work on the historical data 1841-1950.
  # FIRST - create all combinations of groups in historical years - e.g. 1841 all eez, saup, grear, fgroup, sector present in the reference years (1950-1960) with contribution being constant across year (proportions don't change, effort does), 1842 same story ... 
  Year= seq(1841,1949)
  toExpend<-recent_effortB %>% 
    select(-NomActive) %>% 
    unique()

  toExpend<-rbindlist(lapply(1841:1949, function(x,d) data.frame(d, Year=x), d=toExpend))
  toExpend<-as_tibble(toExpend)
  
  # SECOND - get effort value by year for 1841-1950
  # NOTE from historical_effort you consider EFFORT VALUES by year withing LME 
  # not much done here, just data wrangling to get year, effort dataset
  historical_effort<-historical_effort %>% 
    filter(Type == "NomActive") %>% # Here can keep catches too 
    select(-group, -Considered) %>% 
    spread(Type, Value) %>% 
    filter(!is.na(NomActive)) %>% # catch data goes to 2017 but effort to 2010 - source of NAs 
    rename(NomActive_pred = NomActive) 

  # THIRD - merge historical effort values with groups from recent_effortB (through toExpand)
  # and calculate NomActive for each group based on: historical effort values*effort contribution by each group in 1950-1960 (from recent_effortB) 
  final_df<-filter(historical_effort, Year <1950) %>% # this are the only year that we need to reconstruct and merge with recent_effort
    full_join(toExpend) %>% 
    mutate(NomActive = NomActive_pred*contribution) %>% 
    select(-NomActive_pred, -contribution)
  
  # # check - ok - the sum of effort at the LME level matches .... 
  # final_df %>% filter(Year ==1841) %>% mutate(a = sum(NomActive))
  # decision[[1]] %>% filter(Year ==1841) # compare a with original data

  # FORTH - merge merge historical effort where contributions to the groups has been calculated above (1841-1950) with recent_effort (1950-2017)
  # sort(unique(final_df$Year))
  # sort(unique(recent_effort$Year))
  # 
  # tic()
  # final_df1<- lazy_dt(final_df) %>%
  #   full_join(lazy_dt(recent_effort)) %>%
  #   as.data.frame()
  # toc()
  
  # tic()
  final_df<- final_df %>% 
    full_join(recent_effort) %>% 
    as.data.frame()
  # toc()
  
  # # check they give the same ouputs -  
  # trial<-final_df1 %>% 
  #   group_by(Year) %>% 
  #   summarise(effort = sum(NomActive, na.rm = TRUE)) %>%
  #   ungroup()
  # 
  # pdf("Output/trial.pdf", height = 8, width = 6)
  # ggplot(trial, aes(x = Year, y = effort))+
  #   geom_point()
  # dev.off()
  
  # final df for plotting 
  data_plot<-final_df %>%
    group_by(Year, Gear) %>% 
    summarise(NomActive = sum(NomActive, na.rm = TRUE)) %>% 
    ungroup()

  # plot<-ggplot(data_plot, aes(y = NomActive, x = Year, group = Gear, color = Gear))+
  #   geom_line()+
  #   ggtitle(paste("LME", toKeep, sep = " ")) +# WARNING - check this is correct
  #   my_theme

  # create data for annotation 
  yMax = max(data_plot$NomActive, na.rm = TRUE)
    
  # ann_text <- data.frame(Year = c(1841+10,1861+15,1961+15), NomActive = rep(yMax,3), lab = c("Spin-up","Transition","Experiment"), Gear = rep(unique(data_plot$Gear)[1], 3))
  
  ann_text <- data.frame(Year = c(1841+10,1961+15), NomActive = rep(yMax,2), lab = c("Transition","Experiment"), Gear = rep(unique(data_plot$Gear)[1], 2))
  
  plot<-ggplot(data = data_plot, aes(x = Year, y = NomActive, group = Gear, color = Gear)) +
    ggtitle(paste("LME", toKeep, sep = " "))+ # WARNING - check this is correct
    annotate("rect",xmin=1841, xmax=1960, ymin=0, ymax=Inf, fill = "#b2e2e2", alpha = 0.4)+ # spin-up edf8fb
    # annotate("rect",xmin=1861, xmax=1960, ymin=0, ymax=Inf, fill = "#66c2a4", alpha = 0.4)+ # transition b2e2e2
    annotate("rect",xmin=1961, xmax=2010, ymin=0, ymax=Inf, fill = "#238b45", alpha = 0.4)+ # projection 66c2a4
    # annotate("rect",xmin=1841, xmax=1950, ymin=0, ymax=Inf, fill = "#edf8fb", alpha = 0.4)+ # spin-up
    # annotate("rect",xmin=1950, xmax=1961, ymin=0, ymax=Inf, fill = "#b2e2e2", alpha = 0.4)+ # transition
    # annotate("rect",xmin=1961, xmax=2010, ymin=0, ymax=Inf, fill = "#66c2a4", alpha = 0.4)+ # projection 
    # annotate("rect",xmin=2010, xmax=2017, ymin=0, ymax=Inf, fill = "#238b45", alpha = 0.4)+ # validation
    geom_text(data = ann_text,label = ann_text$lab, color = "Black", size = 2)+
    geom_line(size = 0.5)+
    geom_point(size = 0.5)+
    my_theme
    
  if(reference == "1950"){
    plot<-plot+
      geom_vline(xintercept=1950, linetype="dashed", color = "red", size=0.5)
  }else{
    plot<-plot+
      geom_vline(xintercept=1950, linetype="dashed", color = "red", size=0.5)+
      geom_vline(xintercept=1960, linetype="dashed", color = "red", size=0.5)
  }
  
  # # check with gear and FGroup - OK
  # pdf("Output/trial1.pdf", height = 8, width = 6)
  # plot
  # dev.off()
    
  return(list(final_df = final_df, plot = plot))
  
}

```

## Allocate reconstructed effort across groups loop

```{r allocate loop, echo = FALSE, fig.width=10, fig.height=7}

# load("~/FishingEffort/Data/temp_effort.RData")

# decide on version above: 
decision<-reconstructed_effort_LME_war_ref

# First loop ----

toKeep<-sort(unique(effort$LME))
reconstructed_effort_ref<-list()
plot_reconstructed_effort_ref<-list()

for(i in 1:length(decision)){

  # i = 1
  print(toKeep [[i]])
  
  recent_effort<-filter(effort, LME == toKeep [[i]])
  
  # WARNING - need to check that LMEs are matching across datasets and with toKeep - YES matching 
  # a<-effort_spread(decision[[i]], recent_effort, toKeep[[i]], reference = "1950")
  # 
  # reconstructed_effort[[i]] = a$final_df
  # names(reconstructed_effort)[i]<-toKeep[i]
  # plot_reconstructed_effort[[i]] = a$plot
  # names(plot_reconstructed_effort)[i]<-toKeep[i]

  b<-effort_spread(historical_effort = decision[[i]], recent_effort = recent_effort, toKeep = toKeep[[i]], reference = "1950-1960")
  
  reconstructed_effort_ref[[i]] = b$final_df
  names(reconstructed_effort_ref)[i]<-toKeep[i]
  plot_reconstructed_effort_ref[[i]] = b$plot
  names(plot_reconstructed_effort_ref)[i]<-toKeep[i]
  
}

# compare scenarios and decide ----

# combined_plot<-list()
# 
# for(i in 1:length(plot_reconstructed_effort)){
#   
#   # legend <- cowplot::get_legend(plot_reconstructed_effort_LME[[i]])
#   library(patchwork)
#   layout<-"
#   AA
#   BB"
#   combined_plot[[i]]<-plot_reconstructed_effort[[i]]+ plot_reconstructed_effort_ref[[i]] + plot_layout(design = layout)
#   
# }
# 
# # pdf("Output/reconstructed_effort_for_spinup_refDecision.pdf", height = 5, width = 7)
# # for (i in 1:length(combined_plot)){
# #   plot(combined_plot[[i]])
# # }
# # dev.off()

# Decision ----

# reference mean values 1950-1960

# reconstructed_effort_ref
# plot_reconstructed_effort_ref

# show North sea 
# plot_reconstructed_effort_ref[[23]]

# save final data and plots ----

# check empty LME and remove from the list - it should be none
plot_reconstructed_effort_ref<-plot_reconstructed_effort_ref[lapply(plot_reconstructed_effort_ref,length)>0]

pdf("Output/reconstructed_effort_for_spinup_JeromeComments_1841_fixedValues_kappaLME31_EEZ.pdf", height = 8, width = 6)
marrangeGrob(grobs = plot_reconstructed_effort_ref, nrow=2, ncol=1)
dev.off()

# if total cacthes included discards - no need see comment bove  
# pdf("Output/reconstructed_effort_for_spinup_JeromeComments_discards.pdf", height = 8, width = 6)
# marrangeGrob(grobs = plot_reconstructed_effort_ref, nrow=2, ncol=1)
# dev.off()

# from list to df data ----

reconstructed_effort_ref_all<-do.call(rbind.data.frame, reconstructed_effort_ref)

### SAVE DATA HERE for FAO report plots. 
# save(reconstructed_effort_ref_all, file = "~/FishingEffort/Data/temp_effort_EEZ.RData")

```

## FAO EEZ plot and check

```{r}

# IMPORTANT - check difference between previous run where you considered administrative country and second run where you considered actual EEZ. 
unique(reconstructed_effort_ref_all$eez_country_name)

# # Plots for FAO report
# rm(list=ls())
# load("~/FishingEffort/Data/temp_effort_EEZ.RData")
# ls()

# # check LME and EEZ interactions ----
# trial<-effort %>% 
#   select(LME, eez_country_name) %>% 
#   unique()
# 
# trial<-arrange(trial, eez_country_name, LME)
# # calculations below are done at the LME level, in each LME there are multiple EEZ and that's OK. 
# # but in some EEZ there are multiple LME and that could be a problem... not really ... 
# filter(trial, eez_country_name == "France")

eez<-split(reconstructed_effort_ref_all, reconstructed_effort_ref_all$eez_country_name)

trial_plot_list<-list()

for(i in 1:length(eez)){
  
  # i = 1
  trial<-eez[[i]] %>% 
    group_by(Year, eez_country_name) %>% 
    summarise(effort = sum(NomActive, na.rm =TRUE)) %>% 
    ungroup()

  trial_plot_list[[i]]<-ggplot(trial, aes(x = Year, y = effort))+
    geom_point()+
    geom_line()+
    ggtitle(paste("EEZ", names(eez)[i], sep = " "))
  
}

pdf("Output/EEZ2.pdf", height = 8, width = 6) # version "2" is when considering the EEZ instead of the administrative country. 
marrangeGrob(grobs = trial_plot_list, nrow=2, ncol=1)
dev.off()

# check eez
# most evidently problematic - Kenya (in LME 31 and LME0) - LME 31 is somehow problematic as it shows a bump between 1949 and 1950 but with different kappa it shows high effort before 1950, many trials and this seems the best solution so far (see parameterisation above). Most of the bump is "absorbed by Kenya" which is not good for this EEZ but OK if you look at the broader picture - see Kenya.pdf below. Alos LME31 bump not too bad compared to later effort variability. 
# plot proportional contribution of each EEZ to LME 31 (or 0)

a<-reconstructed_effort_ref_all %>% 
  filter(eez_country_name == "Kenya")

unique(a$LME) # 0, 31

nLME<- 31

a<-reconstructed_effort_ref_all %>% 
  filter(eez_country_name == "Haiti")

unique(a$LME) # 12

a<-reconstructed_effort_ref_all %>% 
  filter(eez_country_name == "Cuba")

unique(a$LME) # 5, 12

nLME<- 12

a<-reconstructed_effort_ref_all %>% 
  filter(eez_country_name == "Angola")

unique(a$LME) # 28, 29

nLME<- 29

# # FAO PLOT ---- 
nLME<- 36 # 36 - South China Sea, 34 Bay of Bengal 

# LME and EEZ
data_plot_trial<-reconstructed_effort_ref_all %>% 
  filter(LME == nLME) %>% 
  group_by(Year, eez_country_name, LME) %>% 
  summarise(NomActive = sum(NomActive, na.rm = TRUE)) %>% 
  ungroup()

unique(data_plot_trial$eez_country_name)
head(reconstructed_effort_ref_all)

# EEZ and Gear
data_plot_trial_gear<-reconstructed_effort_ref_all %>% 
  filter(LME == nLME, eez_country_name == "China Main") %>% 
  group_by(Year, eez_country_name, LME, Gear) %>% 
  summarise(NomActive = sum(NomActive, na.rm = TRUE)) %>% 
  ungroup()

head(data_plot_trial_gear)
# View(data_plot_trial_gear)

# Gear and Fgroup
data_plot_trial_Fgroup<-reconstructed_effort_ref_all %>% 
  filter(LME == nLME, eez_country_name == "China Main", Gear == "Gillnets") %>% 
  group_by(Year, eez_country_name, LME, Gear, FGroup) %>% 
  summarise(NomActive = sum(NomActive, na.rm = TRUE)) %>% 
  ungroup()

# FAO PLOT same quality as effort by LME ....
yMax = max(data_plot_trial$NomActive, na.rm = TRUE)

ann_text <- data.frame(Year = c(1841+10,1961+15), eez_country_name = rep(unique(data_plot_trial$eez_country_name)[1], 2), LME = unique(data_plot_trial$LME), NomActive = rep(yMax,2), lab = c("Transition","Experiment"))
   
plot1<-ggplot(data = data_plot_trial, aes(x = Year, y = NomActive, group = eez_country_name, color = eez_country_name)) +
  # ggtitle(paste("LME", nLME, sep = " "))+
  ggtitle("South China Sea")+
  ylab("Fishing effort (DkW)") +
  scale_color_discrete(name = "EEZ", labels = c("Brunei", "China", "Indonesia", "Malaysia", "Philippines", "Taiwan", "Vietnam"))+#, values = c("blue", "red", "yellow", "orange", "pink", "purple", "black")) +
  annotate("rect",xmin=1841, xmax=1960, ymin=0, ymax=Inf, fill = "#b2e2e2", alpha = 0.4)+ # spin-up edf8fb
  annotate("rect",xmin=1961, xmax=2010, ymin=0, ymax=Inf, fill = "#238b45", alpha = 0.4)+ # projection 66c2a4
  geom_text(data = ann_text,label = ann_text$lab, color = "Black", size = 3)+
  geom_vline(xintercept=1950, linetype="dashed", color = "red", size=0.5)+
  geom_vline(xintercept=1960, linetype="dashed", color = "red", size=0.5)+
  geom_line() +
  geom_point(size=1)+
  my_theme

# FAO PLOT same quality as effort by LME ....
yMax = max(data_plot_trial_gear$NomActive, na.rm = TRUE)

ann_text <- data.frame(Year = c(1841+10,1961+15), eez_country_name = rep(unique(data_plot_trial_gear$eez_country_name)[1], 2), LME = unique(data_plot_trial_gear$LME),Gear = rep(unique(data_plot_trial_gear$Gear)[1],2), NomActive = rep(yMax,2), lab = c("Transition","Experiment"))
   
# 5 main ones 
trial<-data_plot_trial_gear %>% 
  group_by(Gear) %>% 
  summarise(a = sum(NomActive)) %>% 
  arrange(-a)

trial<-trial[1:5,]
trial<-trial$Gear

data_plot_trial_gear<- data_plot_trial_gear %>% 
  filter(Gear %in% trial)


plot2<-ggplot(data = data_plot_trial_gear, aes(x = Year, y = NomActive, group = Gear, color = Gear)) +
  # ggtitle(paste("LME", nLME, sep = " "))+
  ggtitle("China Exclusive Economic Zone")+
  ylab("Fishing effort (DkW)") +
  scale_color_discrete(name = "Gear", labels = c("Gillnets","Lines","Purse seine","Bottom trawl","Midw. trawl")) +
  annotate("rect",xmin=1841, xmax=1960, ymin=0, ymax=Inf, fill = "#b2e2e2", alpha = 0.4)+ # spin-up edf8fb
  annotate("rect",xmin=1961, xmax=2010, ymin=0, ymax=Inf, fill = "#238b45", alpha = 0.4)+ # projection 66c2a4
  geom_text(data = ann_text,label = ann_text$lab, color = "Black", size = 3)+
  geom_vline(xintercept=1950, linetype="dashed", color = "red", size=0.5)+
  geom_vline(xintercept=1960, linetype="dashed", color = "red", size=0.5)+
  geom_line() +
  geom_point(size=1)+
  my_theme

# FAO PLOT same quality as effort by LME ....
yMax = max(data_plot_trial_Fgroup$NomActive, na.rm = TRUE)

ann_text <- data.frame(Year = c(1841+10,1961+15), eez_country_name = rep(unique(data_plot_trial_Fgroup$eez_country_name)[1], 2), LME = unique(data_plot_trial_Fgroup$LME), Gear = rep(unique(data_plot_trial_Fgroup$Gear)[1],2), FGroup = rep(unique(data_plot_trial_Fgroup$FGroup)[1],2),NomActive = rep(yMax,2), lab = c("Transition","Experiment"))

# 5 main ones 
trial<-data_plot_trial_Fgroup %>% 
  group_by(FGroup) %>% 
  summarise(a = sum(NomActive)) %>% 
  arrange(-a)

trial<-trial[1:5,]
trial<-trial$FGroup

data_plot_trial_Fgroup<- data_plot_trial_Fgroup %>% 
  filter(FGroup %in% trial)

plot3<-ggplot(data = data_plot_trial_Fgroup, aes(x = Year, y = NomActive, group = FGroup, color = FGroup)) +
  # ggtitle(paste("LME", nLME, sep = " "))+
  ggtitle("Gillnet")+
  ylab("Fishing effort (DkW)") +
  scale_color_discrete(name = "Functional group", labels = c("Benthopel 30-90", "Demersal <30", "Pelagic <30", "Pelagic >90", "Shrimps"))+#, values = c("blue", "red", "yellow", "orange", "pink", "purple", "black")) +
  annotate("rect",xmin=1841, xmax=1960, ymin=0, ymax=Inf, fill = "#b2e2e2", alpha = 0.4)+ # spin-up edf8fb
  annotate("rect",xmin=1961, xmax=2010, ymin=0, ymax=Inf, fill = "#238b45", alpha = 0.4)+ # projection 66c2a4
  geom_text(data = ann_text,label = ann_text$lab, color = "Black", size = 3)+
  geom_vline(xintercept=1950, linetype="dashed", color = "red", size=0.5)+
  geom_vline(xintercept=1960, linetype="dashed", color = "red", size=0.5)+
  geom_line() +
  geom_point(size=1)+
  my_theme


# if FAO PLOT
jpeg("Output/EEZeffortFAOreport_EEZ.jpg", res = 300, units = "in", height = 9, width = 7) # height = 8, width = 6)
plot1/plot2/plot3
dev.off() 


# # if e.g. LME 31 
# pdf("Output/Kenya.pdf", height = 10, width = 12) # height = 8, width = 6)
# plot
# dev.off() # big jump for Kenya but not that bad if looking at the LME-wide picture - low effort for Kenya overall 

# if FAO PLOT
pdf("Output/EEZeffortFAOreport_EEZ.pdf", height = 4, width = 7) # height = 8, width = 6)
plot1
dev.off() 

### check that effort data for LME 31 (or anyLME) matches across datasets ---- 
head(reconstructed_effort_ref_all) # from EEZ etc allocation
trial31<-filter(reconstructed_effort_ref_all, LME == 31)
trial31<-trial31 %>% 
  group_by(Year) %>% 
  summarise(effort = sum(NomActive))

head(trial31)

head(reconstructed_effort_LME_war_ref) # from LME reconstruction 
trial31B<-reconstructed_effort_LME_war_ref$`31`
trial31B<-trial31B %>% 
  filter(Type == "NomActive") %>% 
  group_by(Year) %>% 
  summarise(effort = sum(Value))

head(trial31B)

```

## save final data 

```{r}
# final data adjustment
# head(reconstructed_effort_ref) # remove P, GT, NV, add spin-up, transition, experiment, validation column
reconstructed_effort_ref_all<-reconstructed_effort_ref_all %>% 
  select(-P, -NV) %>% 
  mutate(Phase = case_when (Year %in% c(1841:1860) ~ "spin-up",
                            Year %in% c(1861:1960) ~ "transition",
                            Year %in% c(1961:2010) ~ "experiment",
                            Year > 2010 ~ "validation"))


# head(reconstructed_effort_ref_all) 

yannick_dir <- "/rd/gem/private/users/yannickr"
# after FishMIP meeting 
# fwrite(x = reconstructed_effort_ref_all, file.path(yannick_dir, "effort_histsoc_1841_2017.csv"))
# fwrite(x = reconstructed_effort_ref_all, file.path(yannick_dir, "effort_histsoc_1850_2017.csv"))
fwrite(x = reconstructed_effort_ref_all, file.path(yannick_dir, "effort_histsoc_1841_2017_EEZ.csv")) # considering EEZ instead of administrative country
# if total cacthes included discards - no need see commetn above 
# fwrite(x = reconstructed_effort_ref_all, file.path(yannick_dir, "effort_histsoc_1850_2017_discards.csv"))

# DECISIONS: 
# 1. war, not war for GAM on catch? WAR
# 2. ref year = 1950 or mean 1945-1955? 1945-1955
# 3. ref year when allocating effort across groups 1950 or mean 1950-1960? 1950-1960

# NOTES: 
# NV and P were given as part of the original effort file but are not reconstructed so NA for spin-up. These columns are now deleted (can provide as separate file).
# Some reconstructions are based on very few effort values (LME 6, 18 and 57), need to specify in method. 
# Need to dd a calibration/validation column to catch data 

# check the file 
rm(list=ls())
library(tidyverse)
library(dtplyr)
library(tictoc)
library(data.table)
library(mgcv)
library(gridExtra)

a<-read_csv("/rd/gem/private/users/yannickr/DKRZ_EffortFiles/effort_histsoc_1841_2010.csv")

```

