---
title: "Reconstruct effort for spin-up (1850-1950)"
author: "Camilla Novaglio"
date: "April 2022"
output: 
  html_document:
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, echo = FALSE, message=FALSE)
```

The **AIM** of this file is to extrapolate fishing effort between 1850 and 1950 for model spin up.  

The **METHOD** follows two steps:   

1. We extrapolated effort between 1850 and 1950 for each LME. We followed two paths depending on which data was available:   

    a. If there were at least 10 years of catch data before 1950, **we used catch time series** to extrapolate effort backwards. We fit a GAM on the catch data and thus modeled catch as a spline-based smooth function of year, assuming a Gaussian distribution of data, a log link function, and a k argument of 6. The k argument sets the dimensionality of the smoothing matrix for the parameter year, with lower k resulting in smoother fitted spline. We used this model to predict catch backwards, between 1850 and 1950. We looked at observed and predicted values and corrected for unexpected patterns. This meant trimming the catch data, adjusting the k argument if needed, and re-fitting the GAM. Specifically, we identified the pick in the catch time series and excluded data collected afterwards. This was because we assumed the catch time series followed a sigmoid (Gaussian? Logistic?) function, with a smooth increase in catch until the pick is reached, and considering the ascendant part of the catch time series only resulted in a better statistical fit. We also excluded data collected during WWI and WWII (1914-1918 and 1939-1945) because these data showed lower values and lead to oscillations in the distribution of predicted catches. In addition, we lowered k if, for example, predicted catches showed oscillations. Last, we calculated the rate of change of the predicted catch between 1951 and 1850 relative to 1950, we applied this rate of change to the effort data to extend the fishing effort time series to 1850.    

    b. If there were not at least 10 years of catch data before 1950, we **used effort time series** from 1950 to 2010 to extrapolate effort backwards. Similar to the approach used when we considered catch time series, we fit a GAM to the effort data, modeled effort as a spline-based smooth function of year, and used this model to predict effort between 1850 and 1950. Assumptions, data adjustments and functions argument used in this process were the same as the one used to model the catch data.  

    Removing war years meant that the effect of war on catches and effort is not captured in our reconstruction. While this might be a limitation, the aim of the spin-up is to help models reach equilibrium before the 1950 rather than to capture complex dynamics. The reconstruction method described above is broadly consistent with the method Rousseau et al. (2019; in prep) used to reconstruct effort between 1950 and 2017.  

2. Once we obtained an effort time series extending from 1850 to 2010 for each LME, we used the contribution of effort by EEZ, fishing country, gear, functional group, and sector in 1950 to allocate effort across these groups.    

**Input files:**.  

effort_histsoc_1950_2017.csv from Yannick Rousseau. 

temp_data_from_FishingEffort_Rpj_07script_update.RData for catch data including both historical (before 1950) and recent (after 1950) data from Reg Watson.  

**Functions:**.  

effort_extrapolate(). 

effort_spread().  

**OUTPUT:**.      

1. **reconstructed_effort_for_spinup_totLME.pdf** shows (A) trends in catches, and (B) trend in effort for each LME. Predictions from the GAM model are shown as a fitted line on either catch or effort depending on the approach used (1 or 2 above). The shape of the dots refer to whether data was used in the prediction or not (e.g. data collected after the pick in catches or during war years was not considered when fitting the GAM).       

2. **reconstructed_effort_for_spinup.pdf** shows trends in fishing effort by gear (taken as an effort grouping example) and hece the distribution of the constructed effort for spin-up (1850-1950) across these groups.  

3. **effort_histsoc_1850_2010.csv** final spin-up and effort forcing data. 1850-1950 spin-up (extrapolated), 1950-1961 transition, 1961-2010 simulation.     

*COMMENTS:*.  

1. Can consider country data following Yannick's suggestion. But LME-level is easier to control adn adjust. Note, historical catch data only available for some/few countries, might underestimate catches when aggregating at LME.    

2. Need to repeat the above for gridded data - should we reconstruct global fishing effort and use these estimates to allocate historical effort to each grid cell based on contribution to grid cell in 1950?

*NOTES from Yannick & Reg*. 

1. Yannick: In effort, delete EEZ_unknown - used to make things working, should not include much effort and it refers to all the unknown fishing trips in Yannick's dataset.  

2. Yannick & Reg: There will be mismatches between effort and catch - eg. gears withing LMEs that have catch but no effort and vice versa. About 70% compatibility between the 2 datasets. Mismatches are due to the different ways the 2 datasets were built: Yannick starts from gear to reconstruct effort (e.g. 30 trawlers in fleet) while Reg does not have info on gear so assumes gear based on limited knowledge (e.g most tuna are caught by purse seine) -> effort by gear and fishing group might be different from catch by fishing group. Yannick did some matching when building the effort dataset, but he did not reach the 100% match. There is an effort to connect the two - e.g. use Yannic's effort to base the catch reconstruction and vice versa but no outcome yet. IMPORTANT TO KNOW: the more you aggregate the less mismatch you get - modelers to deal with this, no solution.  

3. Yannick, TO DO: Calculate mean over e.g. 3 years before and 3 years after 1950 in terms of rate of change in catches, otherwise e.g. rate of change between 0.001 and 0.00001 is 100 but both values are close to 0 - this results in big bumps in effort when you apply the rate of change in catches to effort if effort is not closed to 0.  

4. Yannick, DONE DIFFERENTLY: Remove from catches war years (1914-18 and 39-45, and 1931-45 for Asia) as low values effect the GAM. After fitting the GAM, replace war values with real catch data for these year to translate catch into effort otherwise there will be no war effect on effort.    

## Set environment 

```{r environment}

rm(list=ls())

library(tidyverse)
library(dtplyr)
library(tictoc)
library(data.table)
library(mgcv)
library(gridExtra)

select<-dplyr::select

```

## Effort data 

```{r effort}

# effort<-read_csv("/rd/gem/private/users/yannickr/effort_histsoc_1950_2010.csv")
effort<-read_csv("/rd/gem/private/users/yannickr/effort_histsoc_1950_2017.csv")
effort<-effort[,-1]

# Remove Unknown_EEZ before printing the final file as per Yannick's comment 
effort<-effort %>% 
  filter(FGroup != "Unknown_EEZ")

```

## Catch data 

```{r catch}

# refer to 07_cacth_data.rmd for data origin - need to change name
# load("/rd/gem/private/users/yannickr/temp_data_from_FishingEffort_Rpj_07script_update.RData")
# catch<-final_catch %>% 
#   as.data.frame()

# new name 
catch<- read_csv("/rd/gem/private/users/yannickr/catch_histsoc_1869_2017.csv")
head(catch)

# calculate catch as sum of reported and IUU, discards are generally not considered - see Reg's comment
catch$catch_tot<-catch$Reported + catch$IUU

```

## Define plot theme 

```{r theme}

my_theme<-theme_bw()+
  theme(text = element_text(size = 10), # this should be overwritten by the below
        plot.title = element_text(size = 10),
        axis.title = element_text(size = 9),
        axis.text = element_text(size = 8),
        legend.title=element_text(size = 9), 
        legend.text=element_text(size = 8),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        legend.key.size = unit(0.1, "cm")) 
  
```

## Extrapolate total effort by LME function

```{r extrapolate}

toKeep<-sort(unique(effort$LME))

effort_extrapolate<-function(toKeep, kappa, war_param, war_decision, reference){
  
  # # trial - def
  # toKeep=2
  # kappa=6
  # war_param = "exclude"
  # war_decision = "no-add"
  # reference = "1950"

  effort_extr<-effort %>% 
    filter(LME %in% toKeep) %>% 
    group_by(Year) %>% 
    summarise(NomActive = sum(NomActive, na.rm = TRUE)) %>% 
    ungroup()

  maxYearEffort<-max(effort_extr$Year) 
  
  catch_all <- catch %>% 
    filter(LME %in% toKeep) %>% 
    group_by(Year) %>% 
    summarise(catch_tot = sum(catch_tot, na.rm = TRUE))
  
  ## IF ZERO ----
  # if(dim(effort_extr)[1] !=0){ 
  
  ## IF HISTORICAL catch exist ----
  if(dim(filter(catch_all, Year <1950))[1] >=10) {  
    df = catch_all
    var = "catch_tot" 
    chechDataUsed = "catch"
  }else{
      df = effort_extr
      var = "NomActive"
      chechDataUsed = "effort"
      }
  
  # find the pick in data and filter out everything after the pick  
  maxVar<-max(df[[var]])  
  maxVar<-filter(df, eval(as.name(var)) == maxVar)
  toAddBack<-filter(df, Year > maxVar$Year)
  df<-filter(df, Year <= maxVar$Year)
    
  # filter out war years: 1914-18 and 39-45
  year<-sort(unique(df$Year))
  if (year[[1]]<=1918){
    war <- df %>% 
      filter(Year %in% c(1914:1918, 1939:1945)) 
    warToRemove<-war$Year
    }else if (year[[1]]<=1945){
      war<- df %>% 
        filter(Year %in% c(1939:1945)) 
      warToRemove<-war$Year
    }

  # WARNING - does this cover all options? 
  if(year[[1]]<=1918 | year[[1]]<=1945 & war_param == "exclude"){
    df<-filter(df, !Year %in% warToRemove)
    }
    
  # fit the gam 
  gam_model<-gam(eval(as.name(var)) ~ s(Year, k=kappa), data=df, family=gaussian(link="log"))
  df$gam<-round(predict(gam_model,newdata = df,type='response'))

  # # check the gam
  # ylim = c(min(df$gam), max(df$gam))
  # plot(df$Year,df[[var]],  ylim=ylim)
  # par(new=T)
  # plot(df$Year,df$gam,col="red",type='l', ylim=ylim)

  # predict backwards
  newd <- data.frame(Year = seq(1850, maxVar$Year))
  newd$pred <- predict.gam(gam_model,newd,type='response') 
  newd$pred <- ifelse(newd$pred<=0, 0, newd$pred)

  # all data
  df<-df %>%
    full_join(newd, by = "Year") %>% 
    dplyr::select(-gam)
    
  if(var == "catch_tot"){
    
    # 1. calculate rate of change
    
    if(reference == "1950"){
      ref<-df %>% 
        filter(Year == 1950)
      ref<-as.numeric(ref$pred)
    }else{
      # 1B. calculate rate of change based on mean 1945-1955 years 
      ref<-df %>% 
        filter(Year >= 1945, Year <= 1955)
      ref<-as.numeric(mean(ref$pred, na.rm = TRUE))
    }
    
    # re-add war years for calculation of effort (if these were available). Add them to pred, because pred <1950 is what you are basing your calculation of effort on.
    if(war_param == "exclude" & war_decision == "re-add"){
      
    if (year[[1]]<=1914 | year[[1]]<=1939){
      df<-df %>% 
        full_join(war %>% rename(var_war = as.name(var)), by = "Year") %>% 
        mutate(pred = case_when(!is.na(var_war) ~ var_war,
                                  is.na(var_war) ~ pred)) %>% 
        select(-var_war)
    }
    }
      
    rate_of_change<-df %>% 
      arrange(Year) %>% 
      mutate(pred = as.numeric(pred)) %>% 
      mutate(rate = 100 * (pred - ref)/ref) %>% 
      mutate(Trial_back = ref + (rate/100)*ref) # only to check  
  
    # check 
    # filter(rate_of_change, Year >= 1950, Year <= 1960)

    # 2. extend effort back using rate of change in catch 
    
    if(reference == "1950"){
      ref<-effort_extr %>% 
        filter(Year == 1950)
      ref<-as.numeric(ref$NomActive)
    }else{
      # 2B. extend effort back using rate of change in catch using decadal mean 
      ref<-effort_extr %>% 
        filter(Year >= 1945, Year <=1955)
      ref<-as.numeric(mean(ref$NomActive, na.rm = TRUE))
    }
  
    effort_reconstruct<-effort_extr %>% 
      full_join(rate_of_change, by = "Year") %>% 
      mutate(NomActive_catch_based = case_when(Year >= 1950 ~ NomActive,
                                                 Year < 1950 ~ ref + (rate/100)*ref))
    
    # check
    # ggplot(data = effort_reconstruct, aes(x = Year, y = NomActive_catch_based)) +
    #   geom_point()
    # ggplot(data = effort_reconstruct, aes(x = Year, y = pred)) +
    #   geom_point()

    # build effort_all
    effort_all<-effort_reconstruct %>% 
      dplyr::select(Year, NomActive_catch_based) %>% 
      rename(NomActive = NomActive_catch_based) 
    
    # consider only recent years that are in effort and not in catch 
    effort_all<-effort_all %>% 
      filter(Year <= maxYearEffort)
    
    }else{ # END var = cacth_tot; beginning of var = NomActive 
      
      # build effort based on gam on effort. 
      df<-df %>% 
        mutate(NomActive = ifelse(Year <= 1950, pred, NomActive)) 
      
      } # end difference between var 
        
    # FINAL STEPS ----
    
    # 1. add missing data 
    
    # add back war time in raw catches
    if (year[[1]]<=1918 | year[[1]]<=1945){
      df<-df %>% 
      full_join(war %>% rename(var_war = as.name(var)), by = "Year")
    
      if(var == "catch_tot"){
        df<-df %>% 
          mutate(catch_tot = case_when(!is.na(var_war) ~ var_war,
                                       is.na(var_war) ~ eval(as.name(var)))) %>% 
          select(-var_war)
      }else{ 
        # is this needed? 
        df<-df %>% 
          mutate(NomActive = case_when(!is.na(var_war) ~ var_war,
                                       is.na(var_war) ~ eval(as.name(var)))) %>% 
          select(-var_war)
        
      }
      }
    
    # add back data after pick in both catches and effort
    if (dim(toAddBack)[1]!=0){
      df<-df %>% 
        full_join(toAddBack) 
      }
    
    # define df as either cacth_all or effort_all
    if(var == "catch_tot"){
      catch_all<-df
    }else{
      effort_all<-df
    }
    
    # 2. merge and plot 
    final_df<-effort_all %>% 
      full_join(catch_all, by = "Year")
    
    # # relative to 1950
    # # WARNING CHECK THIS - not sure we need it 
    # ref<-final_df %>% 
    #   filter(Year == 1950)
    # 
    # final_relative<-final_df %>% 
    #   mutate(EffRelative = (NomActive-ref$NomActive)/ref$NomActive, 
    #          PredRelative = (pred-as.numeric(ref$pred))/as.numeric(ref$pred),
    #          CatchRelative = (catch_tot-ref$catch_tot)/ref$catch_tot) 
    # 
    # final_relative<-final_relative %>% 
    #   dplyr::select(Year, EffRelative:CatchRelative) %>% 
    #   gather("Type", "Value", -Year)

    # WARNING - check Warning!
    final_df<-final_df %>% 
      gather("Type", "Value", -Year) 
  
    # grouping for plot below - these are the titles of the two stacked plots 
    if(var == "catch_tot"){
      final_df<-final_df %>% 
        mutate(group = ifelse(Type == "NomActive", "Effort (nominal, DkW)", "Catch (tonnes)") )
      
    }else(
      final_df<-final_df %>% 
        mutate(group = ifelse(Type == "catch_tot", "Catch (tonnes)", "Effort (nominal, DkW)") )
    )
    
    # highlight data that was not used in GAM
    if(dim(filter(catch_all, Year <1950))[1] >=10 & war_param == "exclude" & war_decision != "re-add") { 
      final_df <-final_df %>% 
        mutate(Considered = ifelse(Year %in% c(1914:1918, 1939:1945), "No", "Yes"))
    }else{ 
      # WARNING - need another if? 
      final_df <-final_df %>% 
        mutate(Considered = "Yes")
    }
    
    if(dim(toAddBack)[1]!=0){
      final_df <-final_df %>% 
        mutate(Considered = ifelse(Year > maxVar$Year, "No", Considered))
    }
    
    final_df_plot<-final_df %>% 
      rename(Data = Type) %>% 
      mutate(Data = ifelse(Data == "pred", "GAM predictions", "Reconstructed values"),
             Considered = as.factor(Considered))
    
    # make yes always a dot and no always a square even if only dots are present in the plot 
    scale_fill_chris <- function(...){
    ggplot2:::manual_scale(
        'shape', 
        values = setNames(c(16,15), c("Yes", "No")), 
        ...
    )
    }
    
    # create data for annotation 
    yMax = max(filter(final_df, Type == "catch_tot")$Value, na.rm = TRUE)
    
    ann_text <- data.frame(Year = c(1850+5,1950+2,1961+15,2010+5), Value = rep(yMax,4), lab = c("Spin-up","Transition","Experiment", "Validation"), group = rep("Catch (tonnes)", 4), Data = rep("Reconstructed values", 4), Considered = rep("Yes", 4))
    
    plot<-ggplot(data = final_df_plot, aes(x = Year, y = Value, group = Data, color = Data, shape=Considered)) +
      ggtitle(paste("LME", toKeep, sep = " "))+
      facet_wrap(~group, scales = "free", nrow = 2)+
      annotate("rect",xmin=1850, xmax=1950, ymin=0, ymax=Inf, fill = "#edf8fb", alpha = 0.4)+ # spin-up
      annotate("rect",xmin=1950, xmax=1961, ymin=0, ymax=Inf, fill = "#b2e2e2", alpha = 0.4)+ # transition
      annotate("rect",xmin=1961, xmax=2010, ymin=0, ymax=Inf, fill = "#66c2a4", alpha = 0.4)+ # projection 
      annotate("rect",xmin=2010, xmax=2017, ymin=0, ymax=Inf, fill = "#238b45", alpha = 0.4)+ # validation
      geom_text(data = ann_text,label = ann_text$lab, color = "Black", size = 2)+
      geom_point(data = filter(final_df_plot, Data == "Reconstructed values"),size=1)+
      geom_line(data = filter(final_df_plot, Data == "GAM predictions")) +
      scale_color_manual(values = c("blue", "black"), drop = FALSE)+
      scale_fill_chris()+
      my_theme
    
    if(var == "catch_tot"){ # different reference year are only relevent when effort reconstruction is based on catches  
      if(reference == "1950"){
        plot<-plot+
          geom_vline(xintercept=1950, linetype="dashed", color = "red", size=0.5)
      }else{
        plot<-plot+
          geom_vline(xintercept=1945, linetype="dashed", color = "red", size=0.5)+
          geom_vline(xintercept=1955, linetype="dashed", color = "red", size=0.5)
      }}
    
    #   }else{ # if effort reconstruction is based on effort it is simply a continuous of predictions ... so the 1950 is not really needed
    #   plot<-plot+
    #     geom_vline(xintercept=1950, linetype="dashed", color = "red", size=0.5)
    # }
    
    # save outputs 
    return(list(reconstructed_effort_LME = final_df, plot_reconstructed_effort_LME = plot, chechDataUsed = chechDataUsed)) 
    
  # } # END if data exist 
  
} 

```

## Extrapolate total effort by LME loop

```{r extrapolate loop, fig.width=10, fig.height=7}

# first loop ----
# this is with war and ref at 1950 (this only applies to catches)

reconstructed_effort_LME_war<-list()
plot_reconstructed_effort_LME_war<-list()
chechDataUsed<-list()

# fix the k argument in GAM (based on war_param = "include" and reference = 1950)
kappa_values<-data.frame(lme = toKeep, kappa = 6)
kappa_values[c(5, 13,19, 31,56, 57, 61)+1, 2]<-5
kappa_values[c(8)+1, 2]<-4

for(i in 1:length(toKeep)){

  print(toKeep[[i]]) 

  # yes war data when fitting GAM do not re-add original data as otherwise you overwrite predictions
  b<-effort_extrapolate(toKeep[[i]], kappa = kappa_values[i,2], war_param = "include", war_decision = "no-add", reference = "1950")

  reconstructed_effort_LME_war[[i]]<-b$reconstructed_effort_LME
  names(reconstructed_effort_LME_war)[i]<-toKeep[i]

  plot_reconstructed_effort_LME_war[[i]]<-b$plot_reconstructed_effort_LME
  names(plot_reconstructed_effort_LME_war)[i]<-toKeep[i]

  chechDataUsed[[i]]<-b$chechDataUsed
  names(chechDataUsed)[i]<-toKeep[i]
  
}

# plot_reconstructed_effort_LME_war[[59]]

# WARNINGS 

# Warning message:
# Step size truncated due to divergence
# Warning messages:
# 1: attributes are not identical across measure variables;
# they will be dropped 

# second loop ----
# this is with alternatives but considering only the LME where calculations are based on catches 

toKeepCatch<-as.numeric(names(chechDataUsed[chechDataUsed == "catch"]))

reconstructed_effort_LME_catch<-list()
plot_reconstructed_effort_LME_catch<-list()

reconstructed_effort_LME_war_catch<-list()
plot_reconstructed_effort_LME_war_catch<-list()

reconstructed_effort_LME_war_original_catch<-list()
plot_reconstructed_effort_LME_war_original_catch<-list()

reconstructed_effort_LME_ref_catch<-list()
plot_reconstructed_effort_LME_ref_catch<-list()

for(i in 1:length(toKeepCatch)){
  
  print(toKeepCatch[[i]]) 
  
  # no war data when fitting GAM nor when calculating effort based on catch 
  a<-effort_extrapolate(toKeepCatch[[i]], kappa = kappa_values[i,2], war_param = "exclude", war_decision = "no-add", reference = "1950")

  reconstructed_effort_LME_catch[[i]]<-a$reconstructed_effort_LME
  names(reconstructed_effort_LME_catch)[i]<-toKeepCatch[i]
  
  plot_reconstructed_effort_LME_catch[[i]]<-a$plot_reconstructed_effort_LME
  names(plot_reconstructed_effort_LME_catch)[i]<-toKeepCatch[i]

  # yes war data when fitting GAM do not re-add original data as otherwise you overwrite predictions
  b<-effort_extrapolate(toKeepCatch[[i]], kappa = kappa_values[i,2], war_param = "include", war_decision = "no-add", reference = "1950")

  reconstructed_effort_LME_war_catch[[i]]<-b$reconstructed_effort_LME
  names(reconstructed_effort_LME_war_catch)[i]<-toKeepCatch[i]

  plot_reconstructed_effort_LME_war_catch[[i]]<-b$plot_reconstructed_effort_LME
  names(plot_reconstructed_effort_LME_war_catch)[i]<-toKeepCatch[i]

  # no war data when fitting GAM, re-add original data when calcualting effort based on catch
  c<-effort_extrapolate(toKeepCatch[[i]], kappa = kappa_values[i,2], war_param = "exclude", war_decision = "re-add",reference = "1950")

  reconstructed_effort_LME_war_original_catch[[i]]<-c$reconstructed_effort_LME
  names(reconstructed_effort_LME_war_original_catch)[i]<-toKeepCatch[i]

  plot_reconstructed_effort_LME_war_original_catch[[i]]<-c$plot_reconstructed_effort_LME
  names(plot_reconstructed_effort_LME_war_original_catch)[i]<-toKeepCatch[i]

  # change the ref from 1950 to mean(1945-1955) to address higher bumps in effort than catches
  d<-effort_extrapolate(toKeepCatch[[i]], kappa = kappa_values[i,2], war_param = "exclude", war_decision = "no-add", reference = "1945-1955")

  reconstructed_effort_LME_ref_catch[[i]]<-d$reconstructed_effort_LME
  names(reconstructed_effort_LME_ref_catch)[i]<-toKeepCatch[i]

  plot_reconstructed_effort_LME_ref_catch[[i]]<-d$plot_reconstructed_effort_LME
  names(plot_reconstructed_effort_LME_ref_catch)[i]<-toKeepCatch[i]
  
}

# compare scenarios and decide ----

# WAR decision
combined_plot_war_list<-list()

for(i in 1:length(plot_reconstructed_effort_LME_catch)){
  
  plot_reconstructed_effort_LME_catch[[i]]<-plot_reconstructed_effort_LME_catch[[i]]+
    ggtitle(paste("LME", toKeepCatch[[i]], "no war", sep = " ")) +
    theme(legend.position ="none")
  
  plot_reconstructed_effort_LME_war_catch[[i]]<-plot_reconstructed_effort_LME_war_catch[[i]]+
    ggtitle(paste("LME", toKeepCatch[[i]], "war", sep = " ")) +
    theme(legend.position ="none")
  
  plot_reconstructed_effort_LME_war_original_catch[[i]]<-plot_reconstructed_effort_LME_war_original_catch[[i]]+
    ggtitle(paste("LME", toKeepCatch[[i]], "war original values", sep = " ")) +
    theme(legend.position ="none")
  
  # better to combine plots like this otherwise 3 plots in 1 page are too big... 
  combined_plot_war_list[[i]]<-list(plot_reconstructed_effort_LME_catch[[i]], plot_reconstructed_effort_LME_war_catch[[i]], plot_reconstructed_effort_LME_war_original_catch[[i]])
  
}

combined_plot_war_list<-unlist(combined_plot_war_list, recursive=FALSE)

pdf("Output/reconstructed_effort_for_spinup_totLME_warDecision2.pdf", height = 5, width = 7)
for (i in 1:length(combined_plot_war_list)){
  plot(combined_plot_war_list[[i]])
}
dev.off()

# REFERENCE decision
combined_plot_ref<-list()

for(i in 1:length(plot_reconstructed_effort_LME_catch)){
  
  plot_reconstructed_effort_LME_ref_catch[[i]]<-plot_reconstructed_effort_LME_ref_catch[[i]]+
    ggtitle(paste("LME", toKeep[[i]], "ref 1945-1955", sep = " "))+
    theme(legend.position ="none")

  combined_plot_ref[[i]]<-list(plot_reconstructed_effort_LME_catch[[i]], plot_reconstructed_effort_LME_ref_catch[[i]])
  
}

combined_plot_ref<-unlist(combined_plot_ref, recursive=FALSE)

pdf("Output/reconstructed_effort_for_spinup_totLME_refDecision2.pdf", height = 5, width = 7)
for (i in 1:length(combined_plot_ref)){
  plot(combined_plot_ref[[i]])
}
dev.off()

# final loop after DECISION ----

# if catch: include war, ref 1945-1955
# if effort - it does not matter

reconstructed_effort_LME_war_ref<-list()
plot_reconstructed_effort_LME_war_ref<-list()

for(i in 1:length(toKeep)){
  
  print(toKeep[[i]]) 

  # yes war data when fitting GAM do not re-add original data as otherwise you overwrite predictions, reference mean over a decade
  b<-effort_extrapolate(toKeep[[i]], kappa = kappa_values[i,2], war_param = "include", war_decision = "no-add", reference = "1945-1955")

  reconstructed_effort_LME_war_ref[[i]]<-b$reconstructed_effort_LME
  names(reconstructed_effort_LME_war_ref)[i]<-toKeep[i]

  plot_reconstructed_effort_LME_war_ref[[i]]<-b$plot_reconstructed_effort_LME
  names(plot_reconstructed_effort_LME_war_ref)[i]<-toKeep[i]
  
}

# show north sea
plot_reconstructed_effort_LME_war_ref[[22]]

# save and print plots ----

# check empty LME and remove from the list - it should be none
plot_reconstructed_effort_LME_war_ref<-plot_reconstructed_effort_LME_war_ref[lapply(plot_reconstructed_effort_LME_war_ref,length)>0]

ggsave("Output/reconstructed_effort_for_spinup_totLME2.pdf", marrangeGrob(grobs = plot_reconstructed_effort_LME_war_ref, nrow=1, ncol=2), device = "pdf")

```

## Allocate reconstructed effort across groups function

```{r allocate}

effort_spread<-function(historical_effort, recent_effort, toKeep, reference){
  
  # # trial 
  # toKeep = 1
  # reference = "1950"
  # historical_effort = reconstructed_effort_LME[[1]]
  # recent_effort = recent_effort[[1]]
  
  # calculate effort distribution across group using 1950-1960, if you use one year only you might miss important groups not represented in 1950 
  if(reference == "1950"){
    recent_effortB<-recent_effort %>% 
      filter(Year == 1950)
    }else{
      recent_effortB<-recent_effort %>% 
        filter(Year >= 1950, Year <=1960) # strange final plots
    }
  
  recent_effortB<-recent_effortB %>% 
    group_by(eez_country_name,SAUP,Gear,FGroup,Sector, LME) %>% 
    summarise(NomActive = mean(NomActive, na.rm = TRUE)) %>% 
    ungroup() %>% 
    mutate(contribution = NomActive/sum(NomActive, na.rm = TRUE))
  
  # check
  # sum(recent_effortB$contribution, na.rm = TRUE)
  
  # create all combinations of groups and historical years 
  Year= seq(1850,1949)
  toExpend<-recent_effortB %>% 
    select(-NomActive) %>% 
    unique()

  toExpend<-rbindlist(lapply(1850:1949, function(x,d) data.frame(d, Year=x), d=toExpend))
  toExpend<-as_tibble(toExpend)
  
  # get effort by year for 1850-1950
  historical_effort<-historical_effort %>% 
    filter(Type == "NomActive") %>% # Here can keep catches too 
    select(-group, -Considered) %>% 
    spread(Type, Value) %>% 
    filter(!is.na(NomActive)) %>% # catch data goes to 2017 but effort to 2010 - source of NAs 
    rename(NomActive_pred = NomActive) 

  # merge info on historical effort by year and groups 
  final_df<-filter(historical_effort, Year <1950) %>% 
    full_join(toExpend) %>% 
    mutate(NomActive = NomActive_pred*contribution) %>% 
    select(-NomActive_pred, -contribution)
  
  # check - WARNING - not as expected for decadal 
  trial<- final_df %>% filter(Year ==1850) %>% mutate(a = sum(NomActive))

  # merge historical and recent effort
  # WARNING - needs checking 
  final_df<- lazy_dt(final_df) %>% 
    full_join(lazy_dt(recent_effort)) %>% 
    as.data.frame()
  
  data_plot<-final_df %>%
    group_by(Year, Gear) %>% 
    summarise(NomActive = sum(NomActive, na.rm = TRUE)) %>% 
    ungroup()

  # plot<-ggplot(data_plot, aes(y = NomActive, x = Year, group = Gear, color = Gear))+
  #   geom_line()+
  #   ggtitle(paste("LME", toKeep, sep = " ")) +# WARNING - check this is correct
  #   my_theme

  # create data for annotation 
  yMax = max(data_plot$NomActive, na.rm = TRUE)
    
  ann_text <- data.frame(Year = c(1850+5,1950+2,1961+15,2010+5), NomActive = rep(yMax,4), lab = c("Spin-up","Transition","Experiment", "Validation"), Gear = rep(unique(data_plot$Gear)[1], 4))
    
  plot<-ggplot(data = data_plot, aes(x = Year, y = NomActive, group = Gear, color = Gear)) +
    ggtitle(paste("LME", toKeep, sep = " "))+ # WARNING - check this is correct
    annotate("rect",xmin=1850, xmax=1950, ymin=0, ymax=Inf, fill = "#edf8fb", alpha = 0.4)+ # spin-up
    annotate("rect",xmin=1950, xmax=1961, ymin=0, ymax=Inf, fill = "#b2e2e2", alpha = 0.4)+ # transition
    annotate("rect",xmin=1961, xmax=2010, ymin=0, ymax=Inf, fill = "#66c2a4", alpha = 0.4)+ # projection 
    annotate("rect",xmin=2010, xmax=2017, ymin=0, ymax=Inf, fill = "#238b45", alpha = 0.4)+ # validation
    geom_text(data = ann_text,label = ann_text$lab, color = "Black", size = 2)+
    geom_line() +
    geom_line() +
    my_theme
    
  if(reference == "1950"){
    plot<-plot+
      geom_vline(xintercept=1950, linetype="dashed", color = "red", size=0.5)
  }else{
    plot<-plot+
      geom_vline(xintercept=1950, linetype="dashed", color = "red", size=0.5)+
      geom_vline(xintercept=1960, linetype="dashed", color = "red", size=0.5)
  }
    
  return(list(final_df = final_df, plot = plot))
  
}

```

## Allocate reconstructed effort across groups loop

```{r allocate loop, fig.width=10, fig.height=7}

# decide on version above: 
decision<-reconstructed_effort_LME_war_ref

# First loop ----

toKeep<-sort(unique(effort$LME))

reconstructed_effort<-list()
plot_reconstructed_effort<-list()

reconstructed_effort_ref<-list()
plot_reconstructed_effort_ref<-list()


for(i in 1:length(decision)){

  recent_effort<-filter(effort, LME == toKeep [[i]])
  
  # WARNING - need to check that LMEs are matching across datasets and with toKeep
  a<-effort_spread(decision[[i]], recent_effort, toKeep[[i]], reference = "1950")

  reconstructed_effort[[i]] = a$final_df
  names(reconstructed_effort)[i]<-toKeep[i]
  plot_reconstructed_effort[[i]] = a$plot
  names(plot_reconstructed_effort)[i]<-toKeep[i]
  
  b<-effort_spread(decision[[i]], recent_effort, toKeep[[i]], reference = "1950-1960")
  
  reconstructed_effort_ref[[i]] = b$final_df
  names(reconstructed_effort_ref)[i]<-toKeep[i]
  plot_reconstructed_effort_ref[[i]] = b$plot
  names(plot_reconstructed_effort_ref)[i]<-toKeep[i]
  
}

# compare scenarios and decide ----

combined_plot<-list()

for(i in 1:length(plot_reconstructed_effort)){
  
  # legend <- cowplot::get_legend(plot_reconstructed_effort_LME[[i]])
  library(patchwork)
  layout<-"
  AA
  BB"
  combined_plot[[i]]<-plot_reconstructed_effort[[i]]+ plot_reconstructed_effort_ref[[i]] + plot_layout(design = layout)
  
}

pdf("Output/reconstructed_effort_for_spinup_refDecision.pdf", height = 5, width = 7)
for (i in 1:length(combined_plot)){
  plot(combined_plot[[i]])
}
dev.off()

# Decision ----

# reference mean values 1950-1960

# reconstructed_effort_ref
# plot_reconstructed_effort_ref

# show North sea 
plot_reconstructed_effort_ref[[22]]

# save final data and plots ----

# check empty LME and remove from the list - it should be none
plot_reconstructed_effort_ref<-plot_reconstructed_effort_ref[lapply(plot_reconstructed_effort_ref,length)>0]

ggsave("Output/reconstructed_effort_for_spinup.pdf", marrangeGrob(grobs = plot_reconstructed_effort_ref, nrow=1, ncol=2), device = "pdf")

# save data
reconstructed_effort_ref<-do.call(rbind.data.frame, reconstructed_effort_ref)

# final data adjusment
head(reconstructed_effort_ref) # remove P, GT, NV, add spin-up, transition, experiment, validation column
reconstructed_effort_ref<-reconstructed_effort_ref %>% 
  select(-P, -NV) %>% 
  mutate(Phase = case_when (Year %in% c(1850:1949) ~ "spin-up",
                            Year %in% c(1950:1961) ~ "transition",
                            Year %in% c(1962:2010) ~ "experiment",
                            Year > 2010 ~ "validation"))


yannick_dir <- "/rd/gem/private/users/yannickr"
fwrite(x = reconstructed_effort_ref, file.path(yannick_dir, "effort_histsoc_1850_2010.csv")) # this is effort_histsoc_1850_2017.csv but before printing you need to make sure you are not overwriting any other file
```

NOTES: 
Should it be a separate file from effort_histsoc_1961_2010.csv or should we combined the 2? Combined, done 
I used 1950 values for the reconstruction - should 1950-1961 be considered spin-up? yes - but more specifically transition, done 
I used effort to 2010 for the reconstruction - should I used all_effort_aggregated.csv or a version of this with effort data to 2017? Yes, done  

Decisions: 
1. war, not war for GAM on catch? WAR
2. ref year = 1950 or mean 1945-1955? 1945-1955
3. ref year when allocating effort across groups 1950 or mean 1950-1960? 1950-1960

1. N, P and GT were given as part of the original effort file but are not reconstructed so NA for spin-up. Delete these columns and maybe provide them as separate file
2. Some reconstructions are based on very few effort values - See LME 6, 18 and 57 in particular. OK just need to specify in method description 
3. For LME 64 effort is increasing by def. Use LME 66 and apply that rate of change. Find out which is Arctic and make sure taht LME is 0 untill 1950 - new fishery... 
4. Spatial grid cell effort - should we reconstruct that too? if so, should we use the globla trend and allocate effort actoss cells based on effort 5. contribution in 1950 as done for the LME aggregated data? 
6. catch data - which years should we provide? should we add a calibration/validation column? YES 
7. Should we add the same column to the effort data? spin-up, transition, projection, validation? YES 
